<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>The Digital Cat - AWS Log Insights as CloudWatch metrics with Python and Terraform</title>
    <meta charset="utf-8" />
    <meta http-equiv='content-language' content='en-gb'>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="A blog featuring in-depth posts about Python, Scala, TDD, devops, security and all things development">
<meta name="description" content="A step-by-step report on how to build a Lambda function with Terraform and Python to convert Log Insights queries into CloudWatch metrics">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@thedigicat" />
<meta name="twitter:title" content="AWS Log Insights as CloudWatch metrics with Python and Terraform" />
<meta name="twitter:description" content="A step-by-step report on how to build a Lambda function with Terraform and Python to convert Log Insights queries into CloudWatch metrics" />
<meta name="twitter:image" content="https://www.thedigitalcatonline.com/images/aws-log-insights-as-cloudwatch-metrics-with-python-and-terraform.jpg" />
    <script src="https://kit.fontawesome.com/15214b60ba.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400;1,600&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="/theme/css/main.min.css?f6765de3">
    <link href="/images/global/favicon.jpg" rel="icon">
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74364524-1"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     
     gtag('config', 'UA-74364524-1');
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZ55XG1KGG"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     
     gtag('config', 'G-FZ55XG1KGG');
    </script>
  </head>

  <body class="preload">
    <div class="container">
      <div class="sidebar navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
    <li class="link"><a href="/archives/index.html">Archives</a></li>
  </ul>
</div></nav>
<section>
  <article class="card">
    <a href="https://www.thedigitalcat.academy/freebie-first-class-objects">
      <img src="/images/first-class-objects-in-python.jpg" />
    </a>
    <div class="body">
      <h2>First-class objects in Python</h2>
      <p>Higher-order functions, wrappers, and factories</p>
      <div class="actions">
        <a class="action" href="https://www.thedigitalcat.academy/freebie-first-class-objects">Get your FREE copy</a>
      </div>
    </div>
  </article>
</section>
<section>
  <article class="card">
    <a href="https://www.thedigitalcat.academy/8-technologies-you-need-to-learn-now">
      <img src="/images/8-technologies.jpg" />
    </a>
    <div class="body">
      <h2>How do you become a DevOps Engineer?</h2>
      <p>A curated list of 8 technologies you need to learn</p>
      <div class="actions">
        <a class="action" href="https://www.thedigitalcat.academy/8-technologies-you-need-to-learn-now">Get your FREE copy</a>
      </div>
    </div>
  </article>
</section>
<section>
  <header>
    <h2>Categories</h2>
  </header>
<ul>
  <li><a href="/category/programming/">Programming</a></li>
  <li><a href="/category/projects/">Projects</a></li>
  <li><a href="/category/retro/">Retro</a></li>
</ul></section>
<section>
  <header>
    <h2>Feeds</h2>
  </header>
<ul>
  <li><i class="fas fa-rss" aria-hidden="true"></i> <a href="/atom.xml">All posts</a></li>


  <li><i class="fas fa-rss" aria-hidden="true"></i> <a href="/category/programming/atom.xml">All posts in category: Programming</a></li>
</ul></section>
<section>
  <header>
    <h2>Tags</h2>
  </header>
<ul class="tags">
    <li class="tag tag-size-3">
      <a title="Posts about algorithms" href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about amiga" href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about AMQP" href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about architectures" href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about assembly" href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about AWS" href="/categories/aws/">AWS</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about big data" href="/categories/big-data/">big data</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about blogging" href="/categories/blogging/">blogging</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about C" href="/categories/c/">C</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Clojure" href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about compilers" href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about concurrent programming" href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about cryptography" href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about decorators" href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about design" href="/categories/design/">design</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about devops" href="/categories/devops/">devops</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about distributed systems" href="/categories/distributed-systems/">distributed systems</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Django" href="/categories/django/">Django</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Docker" href="/categories/docker/">Docker</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about ed25519" href="/categories/ed25519/">ed25519</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about editor" href="/categories/editor/">editor</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Emacs" href="/categories/emacs/">Emacs</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Erlang" href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Flask" href="/categories/flask/">Flask</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about functional programming" href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about generators" href="/categories/generators/">generators</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Git" href="/categories/git/">Git</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about HTML" href="/categories/html/">HTML</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about HTTP" href="/categories/http/">HTTP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about infrastructure" href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about JavaScript" href="/categories/javascript/">JavaScript</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Lambda" href="/categories/lambda/">Lambda</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about M68000" href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Markdown" href="/categories/markdown/">Markdown</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Mau" href="/categories/mau/">Mau</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaclasses" href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaprogramming" href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Notebook" href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about OOP" href="/categories/oop/">OOP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about operating systems" href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about pelican" href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Pika" href="/categories/pika/">Pika</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Postage" href="/categories/postage/">Postage</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Postgres" href="/categories/postgres/">Postgres</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about pytest" href="/categories/pytest/">pytest</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python" href="/categories/python/">Python</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Python2" href="/categories/python2/">Python2</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python3" href="/categories/python3/">Python3</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about RabbitMQ" href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about refactoring" href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about retroprogramming" href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about RSA" href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Scala" href="/categories/scala/">Scala</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSH" href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSL" href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about TDD" href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Terraform" href="/categories/terraform/">Terraform</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about testing" href="/categories/testing/">testing</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about tools" href="/categories/tools/">tools</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about versioning" href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about video" href="/categories/video/">video</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about WWW" href="/categories/www/">WWW</a>
    </li>
</ul></section>
<section>
  <header>
    <h2>Get in touch</h2>
  </header>
  <ul class="contact">
    <li><i class="fab fa-twitter" aria-hidden="true"></i> <a href="https://twitter.com/thedigicat">Twitter</a></li>
    <li><i class="fab fa-github" aria-hidden="true"></i> <a href="https://github.com/TheDigitalCatOnline">GitHub</a></li>
  </ul>
</section>      </div>
      <div class="page">
	<header class="primary" >
	  <button type="button">
	    <i class="fas fa-bars"></i>
	  </button>
	  <p>The Digital Cat</p>
	</header>
	<div class="mobile-menu navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
    <li class="link"><a href="/archives/index.html">Archives</a></li>
  </ul>
</div></nav>
<section>
  <header>
    <h2>Categories</h2>
  </header>
<ul>
  <li><a href="/category/programming/">Programming</a></li>
  <li><a href="/category/projects/">Projects</a></li>
  <li><a href="/category/retro/">Retro</a></li>
</ul></section>
<section>
  <header>
    <h2>Tags</h2>
  </header>
<ul class="tags">
    <li class="tag tag-size-3">
      <a title="Posts about algorithms" href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about amiga" href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about AMQP" href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about architectures" href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about assembly" href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about AWS" href="/categories/aws/">AWS</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about big data" href="/categories/big-data/">big data</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about blogging" href="/categories/blogging/">blogging</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about C" href="/categories/c/">C</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Clojure" href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about compilers" href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about concurrent programming" href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about cryptography" href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about decorators" href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about design" href="/categories/design/">design</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about devops" href="/categories/devops/">devops</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about distributed systems" href="/categories/distributed-systems/">distributed systems</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Django" href="/categories/django/">Django</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Docker" href="/categories/docker/">Docker</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about ed25519" href="/categories/ed25519/">ed25519</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about editor" href="/categories/editor/">editor</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Emacs" href="/categories/emacs/">Emacs</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Erlang" href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Flask" href="/categories/flask/">Flask</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about functional programming" href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about generators" href="/categories/generators/">generators</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Git" href="/categories/git/">Git</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about HTML" href="/categories/html/">HTML</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about HTTP" href="/categories/http/">HTTP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about infrastructure" href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about JavaScript" href="/categories/javascript/">JavaScript</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Lambda" href="/categories/lambda/">Lambda</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about M68000" href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Markdown" href="/categories/markdown/">Markdown</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Mau" href="/categories/mau/">Mau</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaclasses" href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaprogramming" href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Notebook" href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about OOP" href="/categories/oop/">OOP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about operating systems" href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about pelican" href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Pika" href="/categories/pika/">Pika</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Postage" href="/categories/postage/">Postage</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Postgres" href="/categories/postgres/">Postgres</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about pytest" href="/categories/pytest/">pytest</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python" href="/categories/python/">Python</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Python2" href="/categories/python2/">Python2</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python3" href="/categories/python3/">Python3</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about RabbitMQ" href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about refactoring" href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about retroprogramming" href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about RSA" href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Scala" href="/categories/scala/">Scala</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSH" href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSL" href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about TDD" href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Terraform" href="/categories/terraform/">Terraform</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about testing" href="/categories/testing/">testing</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about tools" href="/categories/tools/">tools</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about versioning" href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about video" href="/categories/video/">video</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about WWW" href="/categories/www/">WWW</a>
    </li>
</ul></section>	</div>
	
<div class="page-content">
  <header>
    <h1>AWS Log Insights as CloudWatch metrics with Python and Terraform</h1>
    <div class="post-info">
      <p>By Leonardo Giordani - <i class="fas fa-calendar-alt"></i> <time datetime="2021-03-22T17:00:00+01:00"> 22/03/2021</time></p>
      <p class="tags">
	<a class="tag category" href="/category/programming/" title="All posts in category Programming">Programming</a>
	<a class="tag" href="/categories/aws/">AWS</a>
	<a class="tag" href="/categories/infrastructure/">infrastructure</a>
	<a class="tag" href="/categories/lambda/">Lambda</a>
	<a class="tag" href="/categories/python/">Python</a>
	<a class="tag" href="/categories/terraform/">Terraform</a>
      </p>
      <p class="share">Share on: <span><a class="" href="https://twitter.com/intent/tweet?text=AWS%20Log%20Insights%20as%20CloudWatch%20metrics%20with%20Python%20and%20Terraform&url=https%3A//www.thedigitalcatonline.com/blog/2021/03/22/aws-log-insights-as-cloudwatch-metrics-with-python-and-terraform/&via=thedigicat&hashtags=aws,infrastructure,lambda,python,terraform" target="_blank" title="Share on Twitter"><i class="fab fa-twitter"></i> Twitter</a></span>
<span><a class="" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//www.thedigitalcatonline.com/blog/2021/03/22/aws-log-insights-as-cloudwatch-metrics-with-python-and-terraform/&title=AWS%20Log%20Insights%20as%20CloudWatch%20metrics%20with%20Python%20and%20Terraform&summary=A%20step-by-step%20report%20on%20how%20to%20build%20a%20Lambda%20function%20with%20Terraform%20and%20Python%20to%20convert%20Log%20Insights%20queries%20into%20CloudWatch%20metrics&source=https%3A//www.thedigitalcatonline.com/blog/2021/03/22/aws-log-insights-as-cloudwatch-metrics-with-python-and-terraform/" target="_blank" title="Share on LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a></span>
<span><a class="" href="https://news.ycombinator.com/submitlink?t=AWS%20Log%20Insights%20as%20CloudWatch%20metrics%20with%20Python%20and%20Terraform&u=https%3A//www.thedigitalcatonline.com/blog/2021/03/22/aws-log-insights-as-cloudwatch-metrics-with-python-and-terraform/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news"></i> HackerNews</a></span>
<span><a class="" href="mailto:?subject=AWS%20Log%20Insights%20as%20CloudWatch%20metrics%20with%20Python%20and%20Terraform&amp;body=https%3A//www.thedigitalcatonline.com/blog/2021/03/22/aws-log-insights-as-cloudwatch-metrics-with-python-and-terraform/" target="_blank" title="Share via Email"><i class="fas fa-envelope"></i> Email</a></span>
<span><a class="" href="https://www.reddit.com/submit?url=https%3A//www.thedigitalcatonline.com/blog/2021/03/22/aws-log-insights-as-cloudwatch-metrics-with-python-and-terraform/&title=AWS%20Log%20Insights%20as%20CloudWatch%20metrics%20with%20Python%20and%20Terraform" target="_blank" title="Share via Reddit"><i class="fab fa-reddit"></i> Reddit</a></span></p>    
    </div>
  </header>
  
  <div class="post-content">
    <p>Recently I started using <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/AnalyzingLogData.html">AWS CloudWatch Log Insights</a> and I find the tool really useful to extract data about the systems I'm running without having to set up dedicated monitoring tools, which come with their own set of permissions, rules, configuration language, and so forth.</p><p>Log Insights allow you to query log outputs with a language based on regular expressions with hints of SQL and to produce tables or graphs of quantities that you need to monitor. For example, the system I am monitoring runs Celery in ECS containers that log received tasks with a line like the following</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>16:39:11,156 [32mINFO [0m [34m[celery.worker.strategy][0m [01mReceived task: lib.tasks.lists.trigger_list_log_notification[9b33b464-d4f9-4909-8d4e-1a3134fead97] [0m
</pre></div>
</div></div><p>In this case the specific function in the system that was triggered is <code>lib.tasks.log_notification</code>, and I'm interested in knowing which functions are called the most, so I can easily count them with</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>parse @message /\[celery\.(?&lt;source&gt;[a-z.]+)\].*Received task: (?&lt;task&gt;[a-z._]+)\[/
 | filter not isblank(source)
 | stats count(*) as number by task
 | sort number desc
 | limit 9
</pre></div>
</div></div><p>This gives me a nice table of the top 9 <code>source</code> functions and the number of <code>task</code> submitted for each, and the time frame can be adjusted with the usual CloudWatch controls</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>1 lib.tasks.lists.trigger_list_log_notification 4559
2 lib.tasks.notify.notify_recipient 397
3 lib.message._send_mobile_push_notification 353
4 lib.tasks.jobs.check_job_cutoffs 178
5 lib.tasks.notify.check_message_cutoffs 177
6 lib.tasks.notify.check_notification_retry 177
7 lib.tasks.notify.async_list_response 81
8 lib.tasks.hmrc_poll.govtalk_periodic_poll 59
9 lib.tasks.lists.recalculate_list_entry 56
</pre></div>
</div></div><p>Using time bins, quantities can also be easily plotted. For example, I can process and visualise the number of received tasks with</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>parse @message /\[celery\.(?&lt;source&gt;[a-z.]+)\].*Received task: (?&lt;task&gt;[a-z._]+)\[/
 | filter not isblank(source)
 | stats count(*) by bin(30s)
</pre></div>
</div></div><p>Unfortunately I quickly discovered an important limitation of Log Insights, that is <strong>queries are not metrics</strong>. Which also immediately implies that I can't set up alarms on those queries. As fun as it is to look at nice plots, I need something automatic that sends me messages or scales up systems in reaction to specific events such as "too many submitted tasks".</p><p>The standard solution to this problem suggested by AWS is to write a Lambda that runs the query and stores the value into a custom CloudWatch metric, which I can then use to satisfy my automation needs. I did it, and in this post I will show you exactly how, using Terraform, Python and Zappa, CloudWatch, and DynamoDB. At the end of the post I will also briefly discuss the cost of the solution.</p><h2 id="the-big-picture">The big picture<a class="headerlink" href="#the-big-picture" title="Permanent link">¶</a></h2><p>Before I get into the details of the specific tools or solutions that I decided to implement, let me have a look at the bigger picture. The initial idea is very simple: a Lambda function can run a specific Log Insights query and store the results in a custom metric, which can in turn be used to trigger alarms and other actions.</p><p>For a single system I already have 4 or 5 of these queries that I'd like to run, and I have multiple systems, so I'd prefer to have a solution that doesn't require me to deploy and maintain a different Lambda for each query. The maintenance can be clearly automated as well, but such a solution smells of duplicated code miles away, and if there is no specific reason to go down that road I prefer to avoid it.</p><p>Since Log Insights queries are just strings of code, however, we can store them somewhere and then simply loop on all of them within the same Lambda function. To implement this, I created a DynamoDB table and every element contains all the data I need to run each query, such as the log group that I want to investigate and the name of the target metric.</p><h2 id="terraform">Terraform<a class="headerlink" href="#terraform" title="Permanent link">¶</a></h2><p>In the following sections I will discuss the main components of the solution from the infrastructural point of view, showing how I created them with Terraform. The four main AWS services that I will use are: <a href="https://aws.amazon.com/dynamodb/">DynamoDB</a>, <a href="https://aws.amazon.com/lambda/">Lambda</a>, <a href="https://aws.amazon.com/iam/">IAM</a>, <a href="https://aws.amazon.com/cloudwatch/">CloudWatch</a>.</p><p>I put the bulk of the code in a module so that I can easily create the same structure for multiple AWS accounts. While my current setup is a bit more complicated that that, the structure of the code can be simplified as</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>+ common
  + lambda-loginsights2metrics
    + cloudwatch.tf
    + dynamodb.tf
    + iam.tf
    + lambda.tf
    + variables.tf
+ account1
  + lambda-loginsights2metrics
    + main.tf
    + variables.tf
</pre></div>
</div></div><h3 id="variables">Variables</h3><p>Since I will refer to them in the following sections, let me show you the four variables I defined for this module.</p><p>First I need to receive the items that I need to store in the DynamoDB table</p><div class="code"><div class="title">common/lambda-loginsights2metrics/variables.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;items&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;list&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>I prefer to have a prefix in front of my components that allows me to duplicate them without clashes</p><div class="code"><div class="title">common/lambda-loginsights2metrics/variables.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;prefix&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;string&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;loginsights2metrics&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>The Lambda function will require a list of security groups that grant access to specific network components</p><div class="code"><div class="title">common/lambda-loginsights2metrics/variables.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;security_groups&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;list&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>Finally, Lambda functions need to be told which VPC subnets they can use to run</p><div class="code"><div class="title">common/lambda-loginsights2metrics/variables.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;vpc_subnets&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;list&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><h4 id="resources">Resources</h4><ul><li><a href="https://www.terraform.io/docs/configuration-0-11/variables.html">Terraform variables</a>.</li><li>An <a href="https://spacelift.io/blog/how-to-use-terraform-variables">in-depth post</a> that explains how to use variables in Terraform, by Sumeet Ninawe</li></ul><h3 id="dynamodb">DynamoDB</h3><p>Let's start with the corner stone, which is the DynamoDB table that contains data for the queries. As DynamoDB is not a SQL database we don't need to define columns in advance. This clearly might get us into trouble later, so we need to be careful and be consistent when we write items, adding everything is needed by the Lambda code.</p><div class="code"><div class="title">common/lambda-loginsights2metrics/dynamodb.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_dynamodb_table&quot;</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.prefix}-items&quot;</span><span class="w"></span>

<span class="w">  </span><span class="na">billing_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;PAY_PER_REQUEST&quot;</span><span class="w"></span>

<span class="w">  </span><span class="na">hash_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SlotName&quot;</span><span class="w"></span>

<span class="w">  </span><span class="nb">attribute</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;SlotName&quot;</span><span class="w"></span>
<span class="w">    </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;S&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>Speaking of items, I assume I will pass them when I call the module, so here I just need to loop on the input variable <code>items</code></p><div class="code"><div class="title">common/lambda-loginsights2metrics/dynamodb.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_dynamodb_table_item&quot;</span><span class="w"> </span><span class="nv">&quot;item&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="nv">var.items</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="na">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_dynamodb_table.loginsights2metrics.name</span><span class="w"></span>
<span class="w">  </span><span class="na">hash_key</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_dynamodb_table.loginsights2metrics.hash_key</span><span class="w"></span>

<span class="w">  </span><span class="na">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">jsonencode</span><span class="p">(</span><span class="nf">element</span><span class="p">(</span><span class="nv">var.items</span><span class="p">,</span><span class="w"> </span><span class="nv">count.index</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>Since the query is written as a Terraform string and will be read from Python there are two small caveats here. To be consistent with Terraform's syntax we need to escape double quotes in the query, and to avoid fights with Python we need to escape backslashes. So for example a valid query like</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>parse @message /\[celery\.(?&lt;source&gt;[a-z.]+)\].*Received task: (?&lt;task&gt;[a-z._]+)\[/
 | filter not isblank(source)
 | stats count(*) as Value by bin(1m)
</pre></div>
</div></div><p>will be stored as</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>&quot;parse @message /\\[celery\\.(?&lt;source&gt;[a-z.]+)\\].*Received task: (?&lt;task&gt;[a-z._]+)\\[/ | filter not isblank(source) | stats count(*) as Value by bin(1m)&quot;
</pre></div>
</div></div><p>Another remark is that the Lambda I will write in Python will read data plotted with the name <code>Value</code> on bins of 1 minute, so the query should end with <code>stats X as Value by bin(1m)</code> where <code>X</code> is a specific stat, for example <code>stats count(*) as Value by bin(1m)</code>.</p><p>The reason behind 1 minute is that the maximum standard resolution of CloudWatch metrics is 1 minute. Should you want more you need to have a look at <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/publishingMetrics.html#high-resolution-metrics">CloudWatch High-Resolution Metrics</a>.</p><h4 id="resources">Resources</h4><ul><li><a href="https://aws.amazon.com/dynamodb/">Amazon DynamoDB</a></li><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/dynamodb_table">aws_dynamodb_table documentation</a></li><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/dynamodb_table_item">aws_dynamodb_table_item documentation</a></li></ul><h3 id="iam-part-1">IAM part 1</h3><p>IAM roles are central in AWS. In this specific case we have the so-called <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-intro-execution-role.html">Lambda execution role</a>, which is the IAM role that the Lambda assumes when you run it. In AWS users or services (that is humans or AWS components) <em>assume</em> a role, receiving the permissions connected with it. To assume roles, however, they need to have a specific permission, a so-called <em>trust policy</em>.</p><p>Let's define a trust policy that allows the Lambda service to assume the role that we will define</p><div class="code"><div class="title">common/lambda-loginsights2metrics/iam.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;aws_iam_policy_document&quot;</span><span class="w"> </span><span class="nv">&quot;trust&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">statement</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">    </span><span class="na">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;sts:AssumeRole&quot;</span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="nb">principals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Service&quot;</span><span class="w"></span>
<span class="w">      </span><span class="na">identifiers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;lambda.amazonaws.com&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>and after that the role in question</p><div class="code"><div class="title">common/lambda-loginsights2metrics/iam.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role&quot;</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="nv">var.prefix</span><span class="w"></span>
<span class="w">  </span><span class="na">assume_role_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_iam_policy_document.trust.json</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>To run, Lambdas need an initial set of permissions which can be found in the canned policy <code>AWSLambdaVPCAccessExecutionRole</code>. You can see the content of the policy in the IAM console or dumping it with <code>aws iam get-policy</code> and <code>aws iam get-policy-version</code></p><div class="code"><div class="content"><div class="highlight"><pre><span></span>$ aws iam get-policy --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
{
    &quot;Policy&quot;: {
        &quot;PolicyName&quot;: &quot;AWSLambdaVPCAccessExecutionRole&quot;,
        &quot;PolicyId&quot;: &quot;ANPAJVTME3YLVNL72YR2K&quot;,
        &quot;Arn&quot;: &quot;arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole&quot;,
        &quot;Path&quot;: &quot;/service-role/&quot;,
        &quot;DefaultVersionId&quot;: &quot;v2&quot;,
        &quot;AttachmentCount&quot;: 0,
        &quot;PermissionsBoundaryUsageCount&quot;: 0,
        &quot;IsAttachable&quot;: true,
        &quot;Description&quot;: &quot;Provides minimum permissions for a Lambda function to execute while accessing a resource within a VPC - create, describe, delete network interfaces and write permissions to CloudWatch Logs. &quot;,
        &quot;CreateDate&quot;: &quot;2016-02-11T23:15:26Z&quot;,
        &quot;UpdateDate&quot;: &quot;2020-10-15T22:53:03Z&quot;
    }
}
$ aws iam get-policy-version --policy-arn arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole --version-id v2
{
    &quot;PolicyVersion&quot;: {
        &quot;Document&quot;: {
            &quot;Version&quot;: &quot;2012-10-17&quot;,
            &quot;Statement&quot;: [
                {
                    &quot;Effect&quot;: &quot;Allow&quot;,
                    &quot;Action&quot;: [
                        &quot;logs:CreateLogGroup&quot;,
                        &quot;logs:CreateLogStream&quot;,
                        &quot;logs:PutLogEvents&quot;,
                        &quot;ec2:CreateNetworkInterface&quot;,
                        &quot;ec2:DescribeNetworkInterfaces&quot;,
                        &quot;ec2:DeleteNetworkInterface&quot;,
                        &quot;ec2:AssignPrivateIpAddresses&quot;,
                        &quot;ec2:UnassignPrivateIpAddresses&quot;
                    ],
                    &quot;Resource&quot;: &quot;*&quot;
                }
            ]
        },
        &quot;VersionId&quot;: &quot;v2&quot;,
        &quot;IsDefaultVersion&quot;: true,
        &quot;CreateDate&quot;: &quot;2020-10-15T22:53:03Z&quot;
    }
}
</pre></div>
</div></div><p>Attaching a canned policy is just a matter of creating a specific <code>aws_iam_role_policy_attachment</code> resource</p><div class="code"><div class="title">common/lambda-loginsights2metrics/iam.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role_policy_attachment&quot;</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics-&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">role</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.loginsights2metrics.name</span><span class="w"></span>
<span class="w">  </span><span class="na">policy_arn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>Now that we have the IAM role and the basic policy we can assign custom permissions to it. We need to grant the Lambda permissions on other AWS components, namely CloudWatch to run Log Insights queries and to store metrics and DynamoDB to retrieve all the items from the queries table.</p><div class="code"><div class="title">common/lambda-loginsights2metrics/iam.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;aws_iam_policy_document&quot;</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">statement</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;cloudwatch:PutMetricData&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;cloudwatch:PutMetricAlarm&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;logs:StartQuery&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;logs:GetQueryResults&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;logs:GetLogEvents&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="na">resources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;*&quot;</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">statement</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;dynamodb:Scan&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="na">resources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_dynamodb_table.loginsights2metrics.arn</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>Through <code>aws_iam_role_policy</code> we can create and assign the policy out of a <code>data</code> structure</p><div class="code"><div class="title">common/lambda-loginsights2metrics/iam.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role_policy&quot;</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">var.prefix</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.loginsights2metrics.name</span><span class="w"></span>
<span class="w">  </span><span class="na">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_iam_policy_document.loginsights2metrics.json</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><h4 id="resources">Resources</h4><ul><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document">aws_iam_policy_document documentation</a></li><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role">aws_iam_role documentation</a></li><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy_attachment">aws_iam_role_policy_attachment documentation</a></li><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy">aws_iam_role_policy documentation</a></li><li><a href="https://docs.aws.amazon.com/cli/latest/reference/iam/get-policy.html">AWS CLI iam get-policy documentation</a></li><li><a href="https://docs.aws.amazon.com/cli/latest/reference/iam/get-policy-version.html">AWS CLI iam get-policy-version documentation</a></li></ul><h3 id="lambda">Lambda</h3><p>We can now create the Lambda function container. I do not use Terraform as a deployer, as I think it should be used to define static infrastructure only, so I will use a dummy function here and later deploy the real code using the AWS CLI.</p><p>The dummy function can be easily created with</p><div class="code"><div class="title">common/lambda-loginsights2metrics/lambda.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;archive_file&quot;</span><span class="w"> </span><span class="nv">&quot;dummy&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">type</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;zip&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">output_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${path.module}/lambda.zip&quot;</span><span class="w"></span>

<span class="w">  </span><span class="nb">source</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">content</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dummy&quot;</span><span class="w"></span>
<span class="w">    </span><span class="na">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;dummy.txt&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>The Lambda function is a bit more complicated. As I mentioned, I'll use Zappa to package the function, so the <code>handler</code> has to be <code>&quot;zappa.handler.lambda_handler&quot;</code>. The IAM role given to the function is the one we defined previously, while <code>memory_size</code> and <code>timeout</code> clearly depend on the specific function. Lambdas should run in private networks, and I won't cover here the steps to create them. The AWS docs contains a lot of details on this topic, e.g. <a href="https://aws.amazon.com/premiumsupport/knowledge-center/internet-access-lambda-function/">https://aws.amazon.com/premiumsupport/knowledge-center/internet-access-lambda-function/</a>.</p><p>The environment variables allow me to inject the name of the DynamoDB table so that I don't need to hardcode it. I also pass another variable, the <a href="https://sentry.io/welcome/">Sentry DSN</a> that I use in my configuration. This is not essential for the problem at hand, but I left it there to show how to pass such values.</p><div class="code"><div class="title">common/lambda-loginsights2metrics/lambda.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lambda_function&quot;</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">function_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;loginsights2metrics&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">handler</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;zappa.handler.lambda_handler&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">runtime</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;python3.8&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">filename</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">data.archive_file.dummy.output_path</span><span class="w"></span>

<span class="w">  </span><span class="na">role</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.loginsights2metrics.arn</span><span class="w"></span>
<span class="w">  </span><span class="na">memory_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">128</span><span class="w"></span>
<span class="w">  </span><span class="na">timeout</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">300</span><span class="w"></span>

<span class="w">  </span><span class="nb">vpc_config</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">subnet_ids</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="nv">var.vpc_subnets</span><span class="w"></span>
<span class="w">    </span><span class="na">security_group_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.security_groups</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">environment</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;SENTRY_DSN&quot;</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://XXXXXX:@sentry.io/YYYYYY&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;DYNAMODB_TABLE&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_dynamodb_table.loginsights2metrics.name</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="nb">lifecycle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">ignore_changes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nb">last_modified, filename</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>Please note that I instructed Terraform to ignore changes to the two attributes <code>last_modified</code> and <code>filename</code>, and that I haven't used any <code>source_code_hash</code>. This way I can safely apply Terraform to change parameters like <code>memory_size</code> or <code>timeout</code> without affecting what I deployed with the CI.</p><p>Since I want to trigger the function from AWS CloudWatch Events I need to grant the service <code>events.amazonaws.com</code> the <code>lambda:InvokeFunction</code> permission.</p><div class="code"><div class="title">common/lambda-loginsights2metrics/lambda.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_lambda_permission&quot;</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">statement_id</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;AllowExecutionFromCloudWatch&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">action</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lambda:InvokeFunction&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">function_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lambda_function.loginsights2metrics.function_name</span><span class="w"></span>
<span class="w">  </span><span class="na">principal</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;events.amazonaws.com&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">source_arn</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_cloudwatch_event_rule.rate.arn</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><h4 id="resources">Resources</h4><ul><li><a href="https://registry.terraform.io/providers/hashicorp/archive/latest/docs/data-sources/archive_file">archive_file documentation</a></li><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_function">aws_lambda_function documentation</a></li><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lambda_permission">aws_lambda_permission documentation</a></li></ul><h3 id="iam-part-2">IAM part 2</h3><p>Since 2018 Lambdas have a maximum execution time of 15 minutes (900 seconds), which is more than enough for many services, but to be conservative I preferred to leverage Zappa's asynchronous calls and to make the main Lambda call itself for each query. The Lambda doesn't clearly call the same Python function (it's not recursive), but from AWS's point of view we have a Lambda that calls itself, so we need to give it a specific permission to do this.</p><div class="code"><div class="title">common/lambda-loginsights2metrics/iam.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;aws_iam_policy_document&quot;</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics_exec&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">statement</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="na">actions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;lambda:InvokeAsync&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;lambda:InvokeFunction&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>

<span class="w">    </span><span class="na">resources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">aws_lambda_function.loginsights2metrics.arn</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>I could not define this when I defined the rest of the IAM components because this needs the Lambda to be defined, but the resource is in the same file. Terraform doesn't care about which resource we defined first and where we define it as long as there are no loops in the definitions.</p><p>We can now assign the newly created policy document to the IAM role we created previously</p><div class="code"><div class="title">common/lambda-loginsights2metrics/iam.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_iam_role_policy&quot;</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics_exec&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.prefix}-exec&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">role</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_iam_role.loginsights2metrics.name</span><span class="w"></span>
<span class="w">  </span><span class="na">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">data.aws_iam_policy_document.loginsights2metrics_exec.json</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><h4 id="resources">Resources</h4><ul><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/data-sources/iam_policy_document">aws_iam_policy_document documentation</a> documentation")</li><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role_policy">aws_iam_role_policy documentation</a></li></ul><h3 id="cloudwatch">CloudWatch</h3><p>Whenever you need to run Lambdas (or other things) periodically, the standard AWS solution is to use CloudWatch Events, which work as the AWS cron system. CloudWatch Events are made of rules and targets, so first of all I defined a rule that gets triggered every 2 minutes</p><div class="code"><div class="title">common/lambda-loginsights2metrics/cloudwatch.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudwatch_event_rule&quot;</span><span class="w"> </span><span class="nv">&quot;rate&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="c1">  # Zappa requires the name to match the processing function</span>
<span class="w">  </span><span class="na">name</span><span class="w">                </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;main.loginsights2metrics&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">description</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Trigger Lambda ${var.prefix}&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">schedule_expression</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;rate(2 minutes)&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>Please note that Zappa has a specific requirement for CloudWatch Events, so I left a comment to clarify this to my future self. The second part of the event is the target, which is the Lambda function that we defined in the previous section.</p><div class="code"><div class="title">common/lambda-loginsights2metrics/cloudwatch.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">resource</span><span class="w"> </span><span class="nc">&quot;aws_cloudwatch_event_target&quot;</span><span class="w"> </span><span class="nv">&quot;lambda&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">rule</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_cloudwatch_event_rule.rate.name</span><span class="w"></span>
<span class="w">  </span><span class="na">target_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${var.prefix}-target&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">arn</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">aws_lambda_function.loginsights2metrics.arn</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><h4 id="resources">Resources</h4><ul><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_rule">aws_cloudwatch_event_rule documentation</a></li><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_event_target">aws_cloudwatch_event_target documentation</a></li></ul><h3 id="using-the-module">Using the module</h3><p>Now the module is finished, so I just need to create some items for the DynamoDB table and to call the module itself</p><div class="code"><div class="title">account1/lambda-loginsights2metrics/main.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="nb">locals</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="na">items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;SlotName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Celery Logs submitted tasks&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;LogGroup&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mycluster/celery&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;ClusterName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mycluster&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;Query&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;parse @message /\\[celery\\.(?&lt;source&gt;[a-z.]+)\\].*Received task: (?&lt;task&gt;[a-z._]+)\\[/ | filter not isblank(source) | stats count(*) as Value by bin(1m)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;Namespace&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Custom&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;MetricName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Submitted tasks&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;SlotName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Celery Logs succeeded tasks&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;LogGroup&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mycluster/celery&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;ClusterName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mycluster&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;Query&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;parse @message /\\[celery.(?&lt;source&gt;[a-z\\._]+)].*Task (?&lt;task&gt;[a-z\\._]+)\\[.*\\] (?&lt;event&gt;[a-z]+)/ | filter source = \&quot;app.trace\&quot; | filter event = \&quot;succeeded\&quot; | stats count(*) as Value by bin(1m)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;Namespace&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Custom&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;MetricName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Succeeded tasks&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;SlotName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Celery Logs retried tasks&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;LogGroup&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mycluster/celery&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;ClusterName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;mycluster&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;Query&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;parse @message /\\[celery.(?&lt;source&gt;[a-z\\._]+)].*Task (?&lt;task&gt;[a-z\\._]+)\\[.*\\] (?&lt;event&gt;[a-z]+)/ | filter source = \&quot;app.trace\&quot; | filter event = \&quot;retry\&quot; | stats count(*) as Value by bin(1m)&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;Namespace&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Custom&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="s2">&quot;MetricName&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s2">&quot;S&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Retried tasks&quot;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>I need to provide a security group for the Lambda, and in this case I can safely use the default one provided by the VPC</p><div class="code"><div class="title">account1/lambda-loginsights2metrics/main.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="nc">&quot;aws_security_group&quot;</span><span class="w"> </span><span class="nv">&quot;default&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">name</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="w"></span>
<span class="w">  </span><span class="na">vpc_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.vpc_id</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>And I can finally call the module</p><div class="code"><div class="title">account1/lambda-loginsights2metrics/main.tf</div><div class="content"><div class="highlight"><pre><span></span><span class="kr">module</span><span class="w"> </span><span class="nv">&quot;loginsights2metrics&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;../../common/lambda-loginsights2metrics&quot;</span><span class="w"></span>

<span class="w">  </span><span class="na">items</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="nv">local.items</span><span class="w"></span>
<span class="w">  </span><span class="na">security_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">data.aws_security_group.default.id</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="na">vpc_subnets</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">var.vpc_private_subnets</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>Please note that the variable <code>vpc_private_subnets</code> is a list of subnet names that I created in another module.</p><h4 id="resources">Resources</h4><ul><li><a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/security_group">aws_security_group documentation</a></li><li><a href="https://www.terraform.io/docs/language/modules/develop/index.html">Creating Terraform modules</a></li></ul><h2 id="python">Python<a class="headerlink" href="#python" title="Permanent link">¶</a></h2><p>As I mentioned before, the Python code of the Lambda function is contained in a different repository and deployed with the CI using <a href="https://github.com/zappa/Zappa">Zappa</a>. Given we are interacting with AWS I am clearly using Boto3, the <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html">AWS SDK for Python</a>. The code was developed locally without Zappa's support, to test out the Boto3 functions I wanted to use, then quickly adjusted to be executed in a Lambda.</p><p>I think the code is pretty straightforward, but I left my original comments to be sure everything is clear. </p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">zappa.asynchronous</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># CONFIG</span>
<span class="n">logs</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;logs&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;eu-west-1&quot;</span><span class="p">)</span>
<span class="n">cw</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;cloudwatch&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;eu-west-1&quot;</span><span class="p">)</span>
<span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">,</span> <span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;eu-west-1&quot;</span><span class="p">)</span>


<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">put_metric_data</span><span class="p">(</span><span class="n">item</span><span class="p">):</span> <span class="callout">3</span>
    <span class="n">slot_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;SlotName&quot;</span><span class="p">]</span>
    <span class="n">log_group</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;LogGroup&quot;</span><span class="p">]</span>
    <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;ClusterName&quot;</span><span class="p">]</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Query&quot;</span><span class="p">]</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;Namespace&quot;</span><span class="p">]</span>
    <span class="n">metric_name</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;MetricName&quot;</span><span class="p">]</span>

    <span class="c1"># This runs the Log Insights query fetching data</span>
    <span class="c1"># for the last 15 minutes.</span>
    <span class="c1"># As we deal with logs processing it&#39;s entirely possible</span>
    <span class="c1"># for the metric to be updated, for example because</span>
    <span class="c1"># a log was received a bit later.</span>
    <span class="c1"># When we put multiple values for the same timestamp</span>
    <span class="c1"># in the metric CW can show max, min, avg, and percentiles.</span>
    <span class="c1"># Since this is an update of a count we should then always</span>
    <span class="c1"># use &quot;max&quot;.</span>
    <span class="n">start_query_response</span> <span class="o">=</span> <span class="n">logs</span><span class="o">.</span><span class="n">start_query</span><span class="p">(</span> <span class="callout">4</span>
        <span class="n">logGroupName</span><span class="o">=</span><span class="n">log_group</span><span class="p">,</span>
        <span class="n">startTime</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()),</span>
        <span class="n">endTime</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()),</span>
        <span class="n">queryString</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">query_id</span> <span class="o">=</span> <span class="n">start_query_response</span><span class="p">[</span><span class="s2">&quot;queryId&quot;</span><span class="p">]</span>

    <span class="c1"># Just polling the API. 5 seconds seems to be a good</span>
    <span class="c1"># compromise between not pestering the API and not paying</span>
    <span class="c1"># too much for the Lambda.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Running&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slot_name</span><span class="si">}</span><span class="s2">: waiting for query to complete ...&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">logs</span><span class="o">.</span><span class="n">get_query_results</span><span class="p">(</span><span class="n">queryId</span><span class="o">=</span><span class="n">query_id</span><span class="p">)</span>

    <span class="c1"># Data comes in a strange format, a dictionary of</span>
    <span class="c1"># {&quot;field&quot;:name,&quot;value&quot;:actual_value}, so this converts</span>
    <span class="c1"># it into something that can be accessed through keys</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]:</span> <span class="callout">5</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

            <span class="n">sample</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>

    <span class="c1"># Now that we have the data, let&#39;s put them into a metric.</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;bin(1m)&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S.000&quot;</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;Value&quot;</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">slot_name</span><span class="si">}</span><span class="s2">: putting </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">cw</span><span class="o">.</span><span class="n">put_metric_data</span><span class="p">(</span> <span class="callout">6</span>
            <span class="n">Namespace</span><span class="o">=</span><span class="n">namespace</span><span class="p">,</span>
            <span class="n">MetricData</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;MetricName&quot;</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">,</span>
                    <span class="s2">&quot;Dimensions&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Cluster&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">cluster_name</span><span class="p">}],</span>
                    <span class="s2">&quot;Timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                    <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;Unit&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">],</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">loginsights2metrics</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span> <span class="callout">1</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;package_info.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">package_info</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">build_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">package_info</span><span class="p">[</span><span class="s2">&quot;build_time&quot;</span><span class="p">])</span>
        <span class="n">build_datetime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">build_timestamp</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###################################&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;LogInsights2Metrics - Build date: &quot;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">build_datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;###################################&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading task from DynamoDB table </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DYNAMODB_TABLE&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DYNAMODB_TABLE&quot;</span><span class="p">])</span>

    <span class="c1"># This is the simplest way to get all entries in the table</span>
    <span class="c1"># The next loop will asynchronously call `put_metric_data`</span>
    <span class="c1"># on each entry.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">Select</span><span class="o">=</span><span class="s2">&quot;ALL_ATTRIBUTES&quot;</span><span class="p">)</span> <span class="callout">2</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s2">&quot;Items&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;* Processing item </span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;SlotName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">put_metric_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
</div></div><p>So, when the Lambda is executed, the entry point is the function <code>loginsights2metrics</code> <span class="callout">1</span> which queries the DynamoDB table <span class="callout">2</span> and loops over all the items contained in it. The loop executes the function <code>put_metric_data</code> <span class="callout">3</span> which being a Zappa <code>task</code> runs it in a new Lambda invocation. This function runs the Log Insights query <span class="callout">4</span>, adjusts Boto3's output <span class="callout">5</span>, and finally puts the values in the custom metric <span class="callout">6</span>.</p><p>The problem I mention in the comment just before I run <code>logs.start_query</code> is interesting. Log Insights are queries, and since they extract data from logs the result can change between two calls of the same query. This means that, since there is an overlap between calls (we run a query on the last 15 minutes every 2 minutes), the function will put multiple values in the same bin of the metric. This is perfectly normal, and it's the reason why CloudWatch allows you to show the maximum, minimum, average, or various percentiles of the same metric. When it comes to counting events, the number can only increase or stay constant in time, but never decrease, so it's sensible to look at the maximum. This is not true if you are looking at execution times, for example, so pay attention to the nature of the underlying query when you graph the metric.</p><p>The Zappa settings I use for the function are</p><div class="code"><div class="title">zappa_settings.json</div><div class="content"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;app_module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;main&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;app_function&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;main.loginsights2metrics&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;runtime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;python3.8&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;log_level&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;WARNING&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;xray_tracing&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nt">&quot;exception_handler&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;zappa_sentry.unhandled_exceptions&quot;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div></div><p>And the requirements are</p><div class="code"><div class="title">requirements.txt</div><div class="content"><div class="highlight"><pre><span></span>zappa
zappa-sentry
</pre></div>
</div></div><p>Please note that as I mentioned before <code>zappa-sentry</code> is not a strict requirement for this solution.</p><p>The code can be packaged and deployed with a simple bash script like</p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nv">VENV_DIRECTORY</span><span class="o">=</span>venv
<span class="nv">LAMBDA_PACKAGE</span><span class="o">=</span>lambda.zip
<span class="nv">REGION</span><span class="o">=</span>eu-west-1
<span class="nv">FUNCTION_NAME</span><span class="o">=</span>loginsights2metrics

<span class="k">if</span> <span class="o">[[</span> -d <span class="si">${</span><span class="nv">VENV_DIRECTORY</span><span class="si">}</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> rm -fR <span class="si">${</span><span class="nv">VENV_DIRECTORY</span><span class="si">}</span><span class="p">;</span> <span class="k">fi</span>
<span class="k">if</span> <span class="o">[[</span> -f <span class="si">${</span><span class="nv">LAMBDA_PACKAGE</span><span class="si">}</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span> rm -fR <span class="si">${</span><span class="nv">LAMBDA_PACKAGE</span><span class="si">}</span><span class="p">;</span> <span class="k">fi</span>

python -m venv <span class="si">${</span><span class="nv">VENV_DIRECTORY</span><span class="si">}</span>
<span class="nb">source</span> <span class="si">${</span><span class="nv">VENV_DIRECTORY</span><span class="si">}</span>/bin/activate

pip install -r requirements.txt

zappa package main -o <span class="si">${</span><span class="nv">LAMBDA_PACKAGE</span><span class="si">}</span>

rm -fR <span class="si">${</span><span class="nv">VENV_DIRECTORY</span><span class="si">}</span>

aws --region<span class="o">=</span><span class="si">${</span><span class="nv">REGION</span><span class="si">}</span> lambda update-function-code --function-name <span class="si">${</span><span class="nv">FUNCTION_NAME</span><span class="si">}</span>  --zip-file <span class="s2">&quot;fileb://</span><span class="si">${</span><span class="nv">LAMBDA_PACKAGE</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div></div>
            <div class="advertisement">
                <a href="https://www.thedigitalcat.academy/freebie-first-class-objects">
                  <img src="/images/first-class-objects/cover.jpg" />
                </a>
                <div class="body">
                  <h2 id="first-class-objects-in-python">First-class objects in Python<a class="headerlink" href="#first-class-objects-in-python" title="Permanent link">¶</a></h2>
<p>Higher-order functions, wrappers, and factories</p>
<p>Learn all you need to know to understand first-class citizenship in Python, the gateway to grasp how decorators work and how functional programming can supercharge your code.</p>
                  <div class="actions">
                    <a class="action" href="https://www.thedigitalcat.academy/freebie-first-class-objects">Get your FREE copy</a>
                  </div>
                </div>
            </div>
            <h2 id="costs">Costs<a class="headerlink" href="#costs" title="Permanent link">¶</a></h2><p>I will follow here the <a href="https://aws.amazon.com/lambda/pricing/">AWS guide on Lambda pricing</a> and the calculations published in 2018 by my colleague João Neves on <a href="https://silvaneves.org/how-much-does-a-lambda-cost.html">his blog</a>.</p><p>I assume the following:</p><ul><li>The Lambda runs 4 queries, so we have 5 invocations (1 for the main Lambda and 4 asynchronous tasks)</li><li>Each invocation runs for 5 seconds. The current average time of each invocation in my AWS accounts is 4.6 seconds</li><li>I run the Lambda every 2 minutes</li></ul><p>Requests: <code>5 invocations/event * 30 events/hour * 24 hours/day * 31 days/month = 111600 requests</code></p><p>Duration: <code>0.128 GB/request * 111600 requests * 5 seconds = 71424 GB-second</code></p><p>Total: <code>$0.20 * 111600 / 10^6 + $0.0000166667 * 71424 ~= $1.22/month</code></p><p>As you can see, for applications like this it's extremely convenient to use a serverless solution like Lambda functions.</p><h2 id="feedback">Feedback<a class="headerlink" href="#feedback" title="Permanent link">¶</a></h2><p>Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="https://github.com/TheDigitalCatOnline/thedigitalcatonline.github.com/issues">GitHub issues</a> page is the best place to submit corrections.</p>
  </div>


  <section>
    <header>
      <h2>Related Posts</h2>
    </header>
    <div class="paginated-posts">
      <div class="posts">
	<article class="card">
          <a href="/blog/2020/02/16/dissecting-a-web-stack/">
            <img src="/images/dissecting-a-web-stack.jpg" alt="dissecting-a-web-stack" />
          </a>
          <div class="body">
            <a href="/blog/2020/02/16/dissecting-a-web-stack/"><h2>Dissecting a Web stack</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/architectures/" class="tag">architectures</a>
		<a href="/categories/concurrent-programming/" class="tag">concurrent programming</a>
		<a href="/categories/cryptography/" class="tag">cryptography</a>
		<a href="/categories/devops/" class="tag">devops</a>
		<a href="/categories/infrastructure/" class="tag">infrastructure</a>
		<a href="/categories/flask/" class="tag">Flask</a>
		<a href="/categories/django/" class="tag">Django</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/ssl/" class="tag">SSL</a>
		<a href="/categories/http/" class="tag">HTTP</a>
		<a href="/categories/www/" class="tag">WWW</a>
		<a href="/categories/aws/" class="tag">AWS</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-02-16T15:00:00+00:00">Feb 16, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2020-10-27T08:30:00+00:00">Oct 27, 2020</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/">
            <img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-1.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-1" />
          </a>
          <div class="body">
            <a href="/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/"><h2>Flask project setup: TDD, Docker, Postgres and more - Part 1</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/aws/" class="tag">AWS</a>
		<a href="/categories/devops/" class="tag">devops</a>
		<a href="/categories/docker/" class="tag">Docker</a>
		<a href="/categories/flask/" class="tag">Flask</a>
		<a href="/categories/http/" class="tag">HTTP</a>
		<a href="/categories/postgres/" class="tag">Postgres</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
		<a href="/categories/www/" class="tag">WWW</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-07-05T13:00:00+01:00">Jul 5, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2021-08-22T10:00:00+00:00">Aug 22, 2021</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/">
            <img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-2.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-2" />
          </a>
          <div class="body">
            <a href="/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/"><h2>Flask project setup: TDD, Docker, Postgres and more - Part 2</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/aws/" class="tag">AWS</a>
		<a href="/categories/devops/" class="tag">devops</a>
		<a href="/categories/docker/" class="tag">Docker</a>
		<a href="/categories/flask/" class="tag">Flask</a>
		<a href="/categories/http/" class="tag">HTTP</a>
		<a href="/categories/postgres/" class="tag">Postgres</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
		<a href="/categories/www/" class="tag">WWW</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-07-06T13:00:00+01:00">Jul 6, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2021-02-23T20:00:00+00:00">Feb 23, 2021</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/">
            <img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-3.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-3" />
          </a>
          <div class="body">
            <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/"><h2>Flask project setup: TDD, Docker, Postgres and more - Part 3</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/aws/" class="tag">AWS</a>
		<a href="/categories/devops/" class="tag">devops</a>
		<a href="/categories/docker/" class="tag">Docker</a>
		<a href="/categories/flask/" class="tag">Flask</a>
		<a href="/categories/http/" class="tag">HTTP</a>
		<a href="/categories/postgres/" class="tag">Postgres</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
		<a href="/categories/www/" class="tag">WWW</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-07-07T13:00:00+01:00">Jul 7, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2021-02-23T20:00:00+00:00">Feb 23, 2021</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2022/02/19/from-docker-cli-to-docker-compose/">
            <img src="/images/from-docker-cli-to-docker-compose.jpg" alt="from-docker-cli-to-docker-compose" />
          </a>
          <div class="body">
            <a href="/blog/2022/02/19/from-docker-cli-to-docker-compose/"><h2>From Docker CLI to Docker Compose</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/devops/" class="tag">devops</a>
		<a href="/categories/docker/" class="tag">Docker</a>
		<a href="/categories/infrastructure/" class="tag">infrastructure</a>
		<a href="/categories/postgres/" class="tag">Postgres</a>
		<a href="/categories/python/" class="tag">Python</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2022-02-19T15:00:00+01:00">Feb 19, 2022</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2022-03-17T10:00:00+00:00">Mar 17, 2022</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/07/18/emacs-configuration-for-python-javascript-terraform-and-blogging/">
            <img src="/images/emacs-configuration-for-python-javascript-terraform-and-blogging.jpg" alt="emacs-configuration-for-python-javascript-terraform-and-blogging" />
          </a>
          <div class="body">
            <a href="/blog/2020/07/18/emacs-configuration-for-python-javascript-terraform-and-blogging/"><h2>Emacs Configuration for Python/JavaScript, Terraform and blogging</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/blogging/" class="tag">blogging</a>
		<a href="/categories/editor/" class="tag">editor</a>
		<a href="/categories/emacs/" class="tag">Emacs</a>
		<a href="/categories/javascript/" class="tag">JavaScript</a>
		<a href="/categories/markdown/" class="tag">Markdown</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/terraform/" class="tag">Terraform</a>
		<a href="/categories/tools/" class="tag">tools</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-07-18T15:30:00+01:00">Jul 18, 2020</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2015/01/12/accessing-attributes-in-python/">
            <img src="/images/accessing-attributes-in-python.jpg" alt="accessing-attributes-in-python" />
          </a>
          <div class="body">
            <a href="/blog/2015/01/12/accessing-attributes-in-python/"><h2>Accessing attributes in Python</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/oop/" class="tag">OOP</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2015-01-12T17:00:00+01:00">Jan 12, 2015</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2022-10-08T14:00:00+01:00">Oct 8, 2022</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2014/05/19/method-overriding-in-python/">
            <img src="/images/method-overriding-in-python.jpg" alt="method-overriding-in-python" />
          </a>
          <div class="body">
            <a href="/blog/2014/05/19/method-overriding-in-python/"><h2>Method overriding in Python</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/oop/" class="tag">OOP</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2014-05-19T13:51:26+02:00">May 19, 2014</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2022-10-08T13:00:00+00:00">Oct 8, 2022</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/03/27/mixin-classes-in-python/">
            <img src="/images/multiple-inheritance-and-mixin-classes-in-python.jpg" alt="multiple-inheritance-and-mixin-classes-in-python" />
          </a>
          <div class="body">
            <a href="/blog/2020/03/27/mixin-classes-in-python/"><h2>Multiple inheritance and mixin classes in Python</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/algorithms/" class="tag">algorithms</a>
		<a href="/categories/django/" class="tag">Django</a>
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-03-27T12:00:00+01:00">Mar 27, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2022-10-08T14:00:00+01:00">Oct 8, 2022</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/08/17/delegation-composition-and-inheritance-in-object-oriented-programming/">
            <img src="/images/delegation-composition-and-inheritance-in-object-oriented-programming.jpg" alt="delegation-composition-and-inheritance-in-object-oriented-programming" />
          </a>
          <div class="body">
            <a href="/blog/2020/08/17/delegation-composition-and-inheritance-in-object-oriented-programming/"><h2>Delegation: composition and inheritance in object-oriented programming</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-08-17T09:00:00+01:00">Aug 17, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2022-10-03T08:00:00+00:00">Oct 3, 2022</time></p>
	    </div>
          </div>
	</article>
      </div>
    </div>
  </section>
  
</div>

      </div>
    </div>
    <script src="/theme/js/packed.js?46a8f903"></script>

  </body>
</html>