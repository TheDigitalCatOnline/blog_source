<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>The Digital Cat - Refactoring with tests in Python: a practical example</title>
    <meta charset="utf-8" />
    <meta http-equiv='content-language' content='en-gb'>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="A blog featuring in-depth posts about Python, Scala, TDD, devops, security and all things development">
<meta name="description" content="A step-by-step review of a refactoring session of Python code, using TDD">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@thedigicat" />
<meta name="twitter:title" content="Refactoring with tests in Python: a practical example" />
<meta name="twitter:description" content="A step-by-step review of a refactoring session of Python code, using TDD" />
<meta name="twitter:image" content="https://www.thedigitalcatonline.com/images/refactoring-with-tests-in-python.jpg" />
    <script src="https://kit.fontawesome.com/15214b60ba.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400;1,600&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="/theme/css/main.min.css?f6765de3">
    <link href="/images/global/favicon.jpg" rel="icon">
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74364524-1"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     
     gtag('config', 'UA-74364524-1');
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZ55XG1KGG"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     
     gtag('config', 'G-FZ55XG1KGG');
    </script>
  </head>

  <body class="preload">
    <div class="container">
      <div class="sidebar navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
    <li class="link"><a href="/archives/index.html">Archives</a></li>
  </ul>
</div></nav>
<section>
  <article class="card">
    <a href="https://www.thedigitalcat.academy/freebie-first-class-objects">
      <img src="/images/first-class-objects-in-python.jpg" />
    </a>
    <div class="body">
      <h2>First-class objects in Python</h2>
      <p>Higher-order functions, wrappers, and factories</p>
      <div class="actions">
        <a class="action" href="https://www.thedigitalcat.academy/freebie-first-class-objects">Get your FREE copy</a>
      </div>
    </div>
  </article>
</section>
<section>
  <header>
    <h2>Tags</h2>
  </header>
<ul class="tags">
    <li class="tag tag-size-3">
      <a title="Posts about algorithms" href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about amiga" href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about AMQP" href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about architecture" href="/categories/architecture/">architecture</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about architectures" href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about assembly" href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about AWS" href="/categories/aws/">AWS</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about big data" href="/categories/big-data/">big data</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about blogging" href="/categories/blogging/">blogging</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about C" href="/categories/c/">C</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Clojure" href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about compilers" href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about concurrent programming" href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about cryptography" href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about decorators" href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about design" href="/categories/design/">design</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about devops" href="/categories/devops/">devops</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about distributed systems" href="/categories/distributed-systems/">distributed systems</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Django" href="/categories/django/">Django</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Docker" href="/categories/docker/">Docker</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about ed25519" href="/categories/ed25519/">ed25519</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about editor" href="/categories/editor/">editor</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Emacs" href="/categories/emacs/">Emacs</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Erlang" href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Flask" href="/categories/flask/">Flask</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about functional programming" href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about generators" href="/categories/generators/">generators</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Git" href="/categories/git/">Git</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about HTML" href="/categories/html/">HTML</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about HTTP" href="/categories/http/">HTTP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about infrastructure" href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about JavaScript" href="/categories/javascript/">JavaScript</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Lambda" href="/categories/lambda/">Lambda</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about M68000" href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Markdown" href="/categories/markdown/">Markdown</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Mau" href="/categories/mau/">Mau</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaclasses" href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaprogramming" href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about networking" href="/categories/networking/">networking</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Notebook" href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about OOP" href="/categories/oop/">OOP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about operating systems" href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about pelican" href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Pika" href="/categories/pika/">Pika</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Postage" href="/categories/postage/">Postage</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Postgres" href="/categories/postgres/">Postgres</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about pytest" href="/categories/pytest/">pytest</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python" href="/categories/python/">Python</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Python2" href="/categories/python2/">Python2</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python3" href="/categories/python3/">Python3</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about RabbitMQ" href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about refactoring" href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about retroprogramming" href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about RSA" href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Scala" href="/categories/scala/">Scala</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSH" href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSL" href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about TDD" href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Terraform" href="/categories/terraform/">Terraform</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about testing" href="/categories/testing/">testing</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about tools" href="/categories/tools/">tools</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about versioning" href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about video" href="/categories/video/">video</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about WWW" href="/categories/www/">WWW</a>
    </li>
</ul></section>
<section>
  <header>
    <h2>Categories</h2>
  </header>
<ul>
  <li><a href="/category/programming/">Programming</a></li>
  <li><a href="/category/projects/">Projects</a></li>
  <li><a href="/category/retro/">Retro</a></li>
</ul></section>
<section>
  <header>
    <h2>Feeds</h2>
  </header>
<ul>
  <li><i class="fas fa-rss" aria-hidden="true"></i> <a href="/atom.xml">All posts</a></li>


  <li><i class="fas fa-rss" aria-hidden="true"></i> <a href="/category/programming/atom.xml">All posts in category: Programming</a></li>
</ul></section>
<section>
  <header>
    <h2>Get in touch</h2>
  </header>
  <ul class="contact">
    <li><i class="fab fa-twitter" aria-hidden="true"></i> <a href="https://twitter.com/thedigicat">Twitter</a></li>
    <li><i class="fab fa-github" aria-hidden="true"></i> <a href="https://github.com/TheDigitalCatOnline">GitHub</a></li>
  </ul>
</section>      </div>
      <div class="page">
	<header class="primary" >
	  <button type="button">
	    <i class="fas fa-bars"></i>
	  </button>
	  <p>The Digital Cat</p>
	</header>
	<div class="mobile-menu navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
    <li class="link"><a href="/archives/index.html">Archives</a></li>
  </ul>
</div></nav>
<section>
  <header>
    <h2>Categories</h2>
  </header>
<ul>
  <li><a href="/category/programming/">Programming</a></li>
  <li><a href="/category/projects/">Projects</a></li>
  <li><a href="/category/retro/">Retro</a></li>
</ul></section>
<section>
  <header>
    <h2>Tags</h2>
  </header>
<ul class="tags">
    <li class="tag tag-size-3">
      <a title="Posts about algorithms" href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about amiga" href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about AMQP" href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about architecture" href="/categories/architecture/">architecture</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about architectures" href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about assembly" href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about AWS" href="/categories/aws/">AWS</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about big data" href="/categories/big-data/">big data</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about blogging" href="/categories/blogging/">blogging</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about C" href="/categories/c/">C</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Clojure" href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about compilers" href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about concurrent programming" href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about cryptography" href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about decorators" href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about design" href="/categories/design/">design</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about devops" href="/categories/devops/">devops</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about distributed systems" href="/categories/distributed-systems/">distributed systems</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Django" href="/categories/django/">Django</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Docker" href="/categories/docker/">Docker</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about ed25519" href="/categories/ed25519/">ed25519</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about editor" href="/categories/editor/">editor</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Emacs" href="/categories/emacs/">Emacs</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Erlang" href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Flask" href="/categories/flask/">Flask</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about functional programming" href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about generators" href="/categories/generators/">generators</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Git" href="/categories/git/">Git</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about HTML" href="/categories/html/">HTML</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about HTTP" href="/categories/http/">HTTP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about infrastructure" href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about JavaScript" href="/categories/javascript/">JavaScript</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Lambda" href="/categories/lambda/">Lambda</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about M68000" href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Markdown" href="/categories/markdown/">Markdown</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Mau" href="/categories/mau/">Mau</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaclasses" href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaprogramming" href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about networking" href="/categories/networking/">networking</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Notebook" href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about OOP" href="/categories/oop/">OOP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about operating systems" href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about pelican" href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Pika" href="/categories/pika/">Pika</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Postage" href="/categories/postage/">Postage</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Postgres" href="/categories/postgres/">Postgres</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about pytest" href="/categories/pytest/">pytest</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python" href="/categories/python/">Python</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Python2" href="/categories/python2/">Python2</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python3" href="/categories/python3/">Python3</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about RabbitMQ" href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about refactoring" href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about retroprogramming" href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about RSA" href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Scala" href="/categories/scala/">Scala</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSH" href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSL" href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about TDD" href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Terraform" href="/categories/terraform/">Terraform</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about testing" href="/categories/testing/">testing</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about tools" href="/categories/tools/">tools</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about versioning" href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about video" href="/categories/video/">video</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about WWW" href="/categories/www/">WWW</a>
    </li>
</ul></section>	</div>
	
<div class="page-content">
  <header>
    <h1>Refactoring with tests in Python: a practical example</h1>
    <div class="post-info">
      <p>By Leonardo Giordani - <i class="fas fa-calendar-alt"></i> <time datetime="2017-07-21T09:30:00+01:00"> 21/07/2017</time></p>
      <p class="tags">
	<a class="tag category" href="/category/programming/" title="All posts in category Programming">Programming</a>
	<a class="tag" href="/categories/oop/">OOP</a>
	<a class="tag" href="/categories/pytest/">pytest</a>
	<a class="tag" href="/categories/python/">Python</a>
	<a class="tag" href="/categories/python3/">Python3</a>
	<a class="tag" href="/categories/refactoring/">refactoring</a>
	<a class="tag" href="/categories/tdd/">TDD</a>
	<a class="tag" href="/categories/testing/">testing</a>
      </p>
      <p class="share">Share on: <span><a class="" href="https://twitter.com/intent/tweet?text=Refactoring%20with%20tests%20in%20Python%3A%20a%20practical%20example&url=https%3A//www.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/&via=thedigicat&hashtags=oop,pytest,python,python3,refactoring,tdd,testing" target="_blank" title="Share on Twitter"><i class="fab fa-twitter"></i> Twitter</a></span>
<span><a class="" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//www.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/&title=Refactoring%20with%20tests%20in%20Python%3A%20a%20practical%20example&summary=A%20step-by-step%20review%20of%20a%20refactoring%20session%20of%20Python%20code%2C%20using%20TDD&source=https%3A//www.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/" target="_blank" title="Share on LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a></span>
<span><a class="" href="https://news.ycombinator.com/submitlink?t=Refactoring%20with%20tests%20in%20Python%3A%20a%20practical%20example&u=https%3A//www.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news"></i> HackerNews</a></span>
<span><a class="" href="mailto:?subject=Refactoring%20with%20tests%20in%20Python%3A%20a%20practical%20example&amp;body=https%3A//www.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/" target="_blank" title="Share via Email"><i class="fas fa-envelope"></i> Email</a></span>
<span><a class="" href="https://www.reddit.com/submit?url=https%3A//www.thedigitalcatonline.com/blog/2017/07/21/refactoring-with-test-in-python-a-practical-example/&title=Refactoring%20with%20tests%20in%20Python%3A%20a%20practical%20example" target="_blank" title="Share via Reddit"><i class="fab fa-reddit"></i> Reddit</a></span></p>    
    </div>
  </header>
  
  <div class="post-content">
    <p>This post contains a step-by-step example of a refactoring session guided by tests. When dealing with untested or legacy code refactoring is dangerous and tests can help us do it the right way, minimizing the amount of bugs we introduce, and possibly completely avoiding them.</p>
<p>Refactoring is not easy. It requires a double effort to understand code that others wrote, or that we wrote in the past, and moving around parts of it, simplifying it, in one word <strong>improving</strong> it, is by no means something for the faint-hearted. Like programming, refactoring has its rules and best practices, but it can be described as a mixture of technique, intuition, experience, risk.</p>
<p>Programming, after all, is craftsmanship.</p>
<h2 id="the-starting-point">The starting point<a class="headerlink" href="#the-starting-point" title="Permanent link">&para;</a></h2>
<p>The simple use case I will use for this post is that of a service API that we can access, and that produces data in JSON format, namely a <strong>list</strong> of elements like the one shown here</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;age&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;surname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Frazier&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;£28943&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p>Once we convert this to a Python data structure we obtain a list of dictionaries, where <code>'age'</code> is an integer, and the remaining fields are strings.</p>
<p>Someone then wrote a class that computes some statistics on the input data. This class, called <code>DataStats</code>, provides a single method <code>stats()</code>, whose inputs are the data returned by the service (in JSON format), and two integers called <code>iage</code> and <code>isalary</code>. Those, according to the short documentation of the class, are the initial age and the initial salary used to compute the average yearly increase of the salary on the whole dataset.</p>
<p>The code is the following</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="n">yearly_avg_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>

        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="n">max_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">min_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                      <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="n">yearly_avg_increase</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">})</span>
</code></pre></div>

<h2 id="the-goal">The goal<a class="headerlink" href="#the-goal" title="Permanent link">&para;</a></h2>
<p>It is fairly easy, even for the untrained eye, to spot some issues in the previous class. A list of the most striking ones is</p>
<ul>
<li>The class exposes a single method and has no <code>__init__()</code>, thus the same functionality could be provided by a single function.</li>
<li>The <code>stats()</code> method is too big, and performs too many tasks. This makes debugging very difficult, as there is a single inextricable piece of code that does everything.</li>
<li>There is a lot of code duplication, or at least several lines that are very similar. Most notably the two operations <code>'£' + str(max(salaries))</code> and <code>'£{}'.format(str(min(salaries)))</code>, the two different lines starting with <code>salaries =</code>, and the several list comprehensions.</li>
</ul>
<p>So, since we are going to use this code in some part of our Amazing New Project™, we want to possibly fix these issues.</p>
<p>The class, however, is working perfectly. It has been used in production for many years and there are no known bugs, so our operation has to be a <strong>refactoring</strong>, which means that we want to write something better, preserving the behaviour of the previous object.</p>
<h2 id="the-path">The path<a class="headerlink" href="#the-path" title="Permanent link">&para;</a></h2>
<p>In this post I want to show you how you can safely refactor such a class using tests. This is different from TDD, but the two are closely related. The class we have has not been created using TDD, as there are no tests, but we can use tests to ensure its behaviour is preserved. This should therefore be called Test Driven Refactoring (TDR).</p>
<p>The idea behind TDR is pretty simple. First, we have to write a test that checks the behaviour of some code, possibly a small part with a clearly defined scope and output. This is a posthumous (or late) unit test, and it simulates what the author of the code should have provided (cough cough, it was you some months ago...).</p>
<p>Once you have you unit test you can go and modify the code, knowing that the behaviour of the resulting object will be the same of the previous one. As you can easily understand, the effectiveness of this methodology depends strongly on the quality of the tests themselves, possibly more than when developing with TDD, and this is why refactoring is hard.</p>
<h2 id="caveats">Caveats<a class="headerlink" href="#caveats" title="Permanent link">&para;</a></h2>
<p>Two remarks before we start our refactoring. The first is that such a class could easily be refactored to some functional code. As you will be able to infer from the final result there is no real reason to keep an object-oriented approach for this code. I decided to go that way, however, as it gave me the possibility to show a design pattern called wrapper, and the refactoring technique that leverages it.</p>
<p>The second remark is that in pure TDD it is strongly advised not to test internal methods, that is those methods that do not form the public API of the object. In general, we identify such methods in Python by prefixing their name with an underscore, and the reason not to test them is that TDD wants you to shape objects according to the object-oriented programming methodology, which considers objects as <strong>behaviours</strong> and not as <strong>structures</strong>. Thus, we are only interested in testing public methods.</p>
<p>It is also true, however, that sometimes even tough we do not want to make a method public, that method contains some complex logic that we want to test. So, in my opinion the TDD advice should sound like "Test internal methods only when they contain some non-trivial logic".</p>
<p>When it comes to refactoring, however, we are somehow deconstructing a previously existing structure, and usually we end up creating a lot of private methods to help extracting and generalising parts of the code. My advice in this case is to test those methods, as this gives you a higher degree of confidence in what you are doing. With experience you will then learn which tests are required and which are not.</p>
<h2 id="setup-of-the-testing-environment">Setup of the testing environment<a class="headerlink" href="#setup-of-the-testing-environment" title="Permanent link">&para;</a></h2>
<p>Clone <a href="https://github.com/lgiordani/datastats">this repository</a> and create a virtual environment. Activate it and install the required packages with </p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements.txt
</code></pre></div>

<p>The repository already contains a configuration file for pytest and you should customise it to avoid entering your virtual environment directory. Go and fix the <code>norecursedirs</code> parameter in that file, adding the name of the virtual environment you just created; I usually name my virtual environments with a <code>venv</code> prefix, and this is why that variable contains the entry <code>venv*</code>.</p>
<p>At this point you should be able to run <code>pytest -svv</code> in the parent directory of the repository (the one that contains <code>pytest.ini</code>), and obtain a result similar to the following</p>
<div class="highlight"><pre><span></span><code><span class="o">==========================</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span>session<span class="w"> </span><span class="nv">starts</span><span class="w"> </span><span class="o">==========================</span>
platform<span class="w"> </span>linux<span class="w"> </span>--<span class="w"> </span>Python<span class="w"> </span><span class="m">3</span>.5.3,<span class="w"> </span>pytest-3.1.2,<span class="w"> </span>py-1.4.34,<span class="w"> </span>pluggy-0.4.0
cachedir:<span class="w"> </span>.cache
rootdir:<span class="w"> </span>datastats,<span class="w"> </span>inifile:<span class="w"> </span>pytest.ini
plugins:<span class="w"> </span>cov-2.5.1
collected<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="nv">items</span><span class="w"> </span>

<span class="o">======================</span><span class="w"> </span>no<span class="w"> </span>tests<span class="w"> </span>ran<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.00<span class="w"> </span><span class="nv">seconds</span><span class="w"> </span><span class="o">======================</span>
</code></pre></div>

<p>The given repository contains two branches. <code>master</code> is the one that you are into, and contains the initial setup, while <code>develop</code> points to the last step of the whole refactoring process. Every step of this post contains a reference to the commit that contains the changes introduced in that section.</p>
<h2 id="step-1-testing-the-endpoints">Step 1 - Testing the endpoints<a class="headerlink" href="#step-1-testing-the-endpoints" title="Permanent link">&para;</a></h2>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/27a1d8ccd5b0a57fa6d9d5f3bd80874538f14ed2">27a1d8c</a></p>
<p>When you start refactoring a system, regardless of the size, you have to test the endpoints. This means that you consider the system as a black box (i.e. you do not know what is inside) and just check the external behaviour. In this case we can write a test that initialises the class and runs the <code>stats()</code> method with some test data, possibly <strong>real</strong> data, and checks the output. Obviously we will write the test with the actual output returned by the method, so this test is automatically passing.</p>
<p>Querying the server we get the following data</p>
<div class="highlight"><pre><span></span><code><span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£27888&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mikayla&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Henry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£67137&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£70472&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<p>and calling the <code>stats()</code> method with that output, with <code>iage</code> set to <code>20</code>, and <code>isalary</code> set to <code>20000</code>, we get the following JSON result</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;avg_age&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;avg_salary&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">55165</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;avg_yearly_increase&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">837</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;max_salary&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">        </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;surname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;age&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">70</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;£70472&quot;</span>
<span class="w">    </span><span class="p">}],</span>
<span class="w">    </span><span class="nt">&quot;min_salary&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">        </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;surname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;age&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">68</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;salary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;£27888&quot;</span>
<span class="w">    </span><span class="p">}]</span>
<span class="p">}</span>
</code></pre></div>

<p>Caveat: I'm using a single very short set of real data, namely a list of 3 dictionaries. In a real case I would test the black box with many different use cases, to ensure I am not just checking some corner case.</p>
<p>The test is the following</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">datastats.datastats</span> <span class="kn">import</span> <span class="n">DataStats</span>


<span class="k">def</span> <span class="nf">test_json</span><span class="p">():</span>
    <span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£27888&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mikayla&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Henry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£67137&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£70472&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="mi">55165</span><span class="p">,</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="mi">837</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
                <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£70472&quot;</span>
            <span class="p">}],</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
                <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£27888&quot;</span>
            <span class="p">}]</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>

<p>As said before, this test is obviously passing, having been artificially constructed from a real execution of the code.</p>
<p>Well, this test is very important! Now we know that if we change something inside the code, altering the behaviour of the class, at least one test will fail.</p>
<h2 id="step-2-getting-rid-of-the-json-format">Step 2 - Getting rid of the JSON format<a class="headerlink" href="#step-2-getting-rid-of-the-json-format" title="Permanent link">&para;</a></h2>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/65e2997d71ade752633229186c6669803a46f185">65e2997</a></p>
<p>The method returns its output in JSON format, and looking at the class it is pretty evident that the conversion is done by <code>json.dumps()</code>.</p>
<p>The structure of the code is the following</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="p">[</span><span class="n">code_part_1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="p">[</span><span class="n">code_part_2</span><span class="p">]</span>
        <span class="p">})</span>
</code></pre></div>

<p>Where obviously <code>code_part_2</code> depends on <code>code_part_1</code>. The first refactoring, then, will follow this procedure</p>
<p>1. We write a test called <code>test__stats()</code> for a <code>_stats()</code> method that is supposed to return the data as a Python structure. We can infer the latter manually from the JSON or running <code>json.loads()</code> from a Python shell. The test fails.</p>
<p>2. We <strong>duplicate</strong> the code of the <code>stats()</code> method that produces the data, putting it in the new <code>_stats()</code> method. The test passes.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
        <span class="p">[</span><span class="n">code_part_1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">code_part_2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="p">[</span><span class="n">code_part_1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
            <span class="p">[</span><span class="n">code_part_2</span><span class="p">]</span>
        <span class="p">})</span>
</code></pre></div>

<p>3. We remove the duplicated code in <code>stats()</code> replacing it with a call to <code>_stats()</code></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
        <span class="p">[</span><span class="n">code_part_1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">code_part_2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<p>At this point we could refactor the initial test <code>test_json()</code> that we wrote, but this is an advanced consideration, and I'll leave it for some later notes.</p>
<p>So now the code of our class looks like this</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="n">yearly_avg_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>

        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="n">max_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">min_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                      <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="n">yearly_avg_increase</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<p>and we have two tests that check the correctness of it.</p>
<h2 id="step-3-refactoring-the-tests">Step 3 - Refactoring the tests<a class="headerlink" href="#step-3-refactoring-the-tests" title="Permanent link">&para;</a></h2>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/d61901754b83ccc36fa25bcebf88da7cace28ff2">d619017</a></p>
<p>It is pretty clear that the <code>test_data</code> list of dictionaries is bound to be used in every test we will perform, so it is high time we moved that to a global variable. There is no point now in using a fixture, as the test data is just static data.</p>
<p>We could also move the output data to a global variable, but the upcoming tests are not using the whole output dictionary any more, so we can postpone the decision.</p>
<p>The test suite now looks like </p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">datastats.datastats</span> <span class="kn">import</span> <span class="n">DataStats</span>


<span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£27888&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mikayla&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Henry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£67137&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£70472&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">test_json</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="o">==</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="mi">55165</span><span class="p">,</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="mi">837</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
                <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£70472&quot;</span>
            <span class="p">}],</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
                <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
                <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
                <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£27888&quot;</span>
            <span class="p">}]</span>
        <span class="p">}</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test__stats</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_stats</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="mi">62</span><span class="p">,</span>
        <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="mi">55165</span><span class="p">,</span>
        <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="mi">837</span><span class="p">,</span>
        <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£70472&quot;</span>
        <span class="p">}],</span>
        <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="p">[{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
            <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
            <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£27888&quot;</span>
        <span class="p">}]</span>
    <span class="p">}</span>
</code></pre></div>

<h2 id="step-4-isolate-the-average-age-algorithm">Step 4 - Isolate the average age algorithm<a class="headerlink" href="#step-4-isolate-the-average-age-algorithm" title="Permanent link">&para;</a></h2>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/9db18036eee2f6712384195fcd970303387291f6">9db1803</a></p>
<p>Isolating independent features is a key target of software design. Thus, our refactoring shall aim to disentangle the code dividing it into small separated functions.</p>
<p>The output dictionary contains five keys, and each of them corresponds to a value computed either on the fly (for <code>avg_age</code> and <code>avg_salary</code>) or by the method's code (for <code>avg_yearly_increase</code>, <code>max_salary</code>, and <code>min_salary</code>). We can start replacing the code that computes the value of each key with dedicated methods, trying to isolate the algorithms.</p>
<p>To isolate some code, the first thing to do is to duplicate it, putting it into a dedicated method. As we are refactoring with tests, the first thing is to write a test for this method.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test__avg_age</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">62</span>
</code></pre></div>

<p>We know that the method's output shall be <code>62</code> as that is the value we have in the output data of the original <code>stats()</code> method. Please note that there is no need to pass <code>iage</code> and <code>isalary</code> as they are not used in the refactored code.</p>
<p>The test fails, so we can dutifully go and duplicate the code we use to compute <code>'avg_age'</code></p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_avg_age</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</code></pre></div>

<p>and once the test passes we can replace the duplicated code in <code>_stats()</code> with a call to <code>_avg_age()</code></p>
<div class="highlight"><pre><span></span><code>        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="n">yearly_avg_increase</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">}</span>
</code></pre></div>

<p>Checking after that that no test is failing. Well done! We isolated the first feature, and our refactoring produced already three tests.</p>
<h2 id="step-5-isolate-the-average-salary-algorithm">Step 5 - Isolate the average salary algorithm<a class="headerlink" href="#step-5-isolate-the-average-salary-algorithm" title="Permanent link">&para;</a></h2>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/412220145ea4d7ef846b1d1f289b4ddefc4fb24b">4122201</a></p>
<p>The <code>avg_salary</code> key works exactly like the <code>avg_age</code>, with different code. Thus, the refactoring process is the same as before, and the result should be a new <code>test__avg_salary()</code> test</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test__avg_salary</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">55165</span>
</code></pre></div>

<p>a new <code>_avg_salary()</code> method</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_avg_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</code></pre></div>

<p>and a new version of the final return value</p>
<div class="highlight"><pre><span></span><code>        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="n">yearly_avg_increase</span><span class="p">,</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="step-6-isolate-the-average-yearly-increase-algorithm">Step 6 - Isolate the average yearly increase algorithm<a class="headerlink" href="#step-6-isolate-the-average-yearly-increase-algorithm" title="Permanent link">&para;</a></h2>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/4005145f39d36fda0519127d57e1b4099d24e72b">4005145</a></p>
<p>The remaining three keys are computed with algorithms that, being longer than one line, couldn't be squeezed directly in the definition of the dictionary. The refactoring process, however, does not really change; as before, we first test a helper method, then we define it duplicating the code, and last we call the helper removing the code duplication.</p>
<p>For the average yearly increase of the salary we have a new test</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test__avg_yearly_increase</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_avg_yearly_increase</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">837</span>
</code></pre></div>

<p>a new method that passes the test</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_avg_yearly_increase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>
</code></pre></div>

<p>and a new version of the <code>_stats()</code> method</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="n">max_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">min_salary</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                      <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_yearly_increase</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">),</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="n">max_salary</span><span class="p">,</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="n">min_salary</span>
        <span class="p">}</span>
</code></pre></div>

<p>Please note that we are not solving any code duplication but the ones that we introduce to refactor. The first achievement we should aim to is to completely isolate independent features.</p>
<h2 id="step-7-isolate-max-and-min-salary-algorithms">Step 7 - Isolate max and min salary algorithms<a class="headerlink" href="#step-7-isolate-max-and-min-salary-algorithms" title="Permanent link">&para;</a></h2>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/17b24138e712f9174b072a579a2dfc9e2800e6ac">17b2413</a></p>
<p>When refactoring we shall always do one thing at a time, but for the sake of conciseness, I'll show here the result of two refactoring steps at once. I'll recommend the reader to perform them as independent steps, as I did when I wrote the code that I am posting below.</p>
<p>The new tests are</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test__max_salary</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_max_salary</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="p">[{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£70472&quot;</span>
    <span class="p">}]</span>


<span class="k">def</span> <span class="nf">test__min_salary</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_min_salary</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="p">[{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£27888&quot;</span>
    <span class="p">}]</span>
</code></pre></div>

<p>The new methods in the <code>DataStats</code> class are</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>
</code></pre></div>

<p>and the <code>_stats()</code> method is now really tiny</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_age&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;avg_yearly_increase&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_yearly_increase</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">),</span>
            <span class="s1">&#39;max_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_salary</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
            <span class="s1">&#39;min_salary&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_salary</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="step-8-reducing-code-duplication">Step 8 - Reducing code duplication<a class="headerlink" href="#step-8-reducing-code-duplication" title="Permanent link">&para;</a></h2>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/b559a5c91ef58e1e734ac97b676468d09a460a45">b559a5c</a></p>
<p>Now that we have the main tests in place we can start changing the code of the various helper methods. These are now small enough to allow us to change the code without further tests. While this can be true in this case, however, in general there is no definition of what "small enough" means, as there is no real definition of what "unit test" is. Generally speaking you should be confident that the change that you are doing is covered by the tests that you have. Weren't this the case, you'd better add one or more tests until you feel confident enough.</p>
<p>The two methods <code>_max_salary()</code> and <code>_min_salary()</code> share a great deal of code, even though the second one is more concise</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span>
                <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))]</span>
</code></pre></div>

<p>I'll start by making explicit the <code>threshold</code> variable in the second function. As soon as I change something, I'll run the tests to check that the external behaviour did not change.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>
</code></pre></div>

<p>Now, it is pretty evident that the two functions are the same but for the <code>min()</code> and <code>max()</code> functions. They still use different variable names and different code to format the threshold, so my first action is to even out them, copying the code of <code>_min_salary()</code> to <code>_max_salary()</code> and changing <code>min()</code> to <code>max()</code></p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute max salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Compute min salary</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>
</code></pre></div>

<p>Now I can create another helper called <code>_select_salary()</code> that duplicates that code and accepts a function, used instead of <code>min()</code> or <code>max()</code>. As I did before, first I duplicate the code, and then remove the duplication by calling the new function.</p>
<p>After some passages, the code looks like this</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_select_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">salaries</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_max_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_salary</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_min_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_salary</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">min</span><span class="p">)</span>
</code></pre></div>

<p>I noticed then a code duplication between <code>_avg_salary()</code> and <code>_select_salary()</code></p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_avg_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_select_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">salaries</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</code></pre></div>

<p>and decided to extract the common algorithm in a method called <code>_salaries()</code>. As before, I write the test first</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_salaries</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">DataStats</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_salaries</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="mi">27888</span><span class="p">,</span> <span class="mi">67137</span><span class="p">,</span> <span class="mi">70472</span><span class="p">]</span>
</code></pre></div>

<p>then I implement the method</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_salaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</code></pre></div>

<p>and eventually I replace the duplicated code with a call to the new method</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_salaries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_select_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="s1">&#39;£</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_salaries</span><span class="p">(</span><span class="n">data</span><span class="p">))))</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;salary&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">threshold</span><span class="p">]</span>
</code></pre></div>

<p>While doing this I noticed that <code>_avg_yearly_increase()</code> contains the same code, and fix it there as well.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_avg_yearly_increase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_salaries</span><span class="p">(</span><span class="n">data</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>
</code></pre></div>

<p>It would be useful at this point to store the input data inside the class and to use it as <code>self.data</code> instead of passing it around to all the class's methods. This however would break the class's API, as <code>DataStats</code> is currently initialised without any data. Later I will show how to introduce changes that potentially break the API, and briefly discuss the issue. For the moment, however, I'll keep changing the class without modifying the external interface.</p>
<p>It looks like <code>age</code> has the same code duplication issues as <code>salary</code>, so with the same procedure I introduce the <code>_ages()</code> method and change the <code>_avg_age()</code> and <code>_avg_yearly_increase()</code> methods accordingly.</p>
<p>Speaking of <code>_avg_yearly_increase()</code>, the code of that method contains the code of the <code>_avg_age()</code> and <code>_avg_salary()</code> methods, so it is worth replacing it with two calls. As I am moving code between existing methods, I do not need further tests.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_avg_yearly_increase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="c1"># iage and isalary are the starting age and salary used to</span>
        <span class="c1"># compute the average yearly increase of salary.</span>

        <span class="c1"># Compute average yearly increase</span>
        <span class="n">average_age_increase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_age</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">iage</span>
        <span class="n">average_salary_increase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avg_salary</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="n">isalary</span>

        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">average_salary_increase</span><span class="o">/</span><span class="n">average_age_increase</span><span class="p">)</span>
</code></pre></div>

<h2 id="step-9-advanced-refactoring">Step 9 - Advanced refactoring<a class="headerlink" href="#step-9-advanced-refactoring" title="Permanent link">&para;</a></h2>
<p>Commit: <a href="https://github.com/lgiordani/datastats/commit/cc0b0a105ebc882cb73831b177e881bb65f4b491">cc0b0a1</a></p>
<p>The initial class didn't have any <code>__init__()</code> method, and was thus missing the encapsulation part of the object-oriented paradigm. There was no reason to keep the class, as the <code>stats()</code> method could have easily been extracted and provided as a plain function.</p>
<p>This is much more evident now that we refactored the method, because we have 10 methods that accept <code>data</code> as a parameter. I would be nice to load the input data into the class at instantiation time, and then access it as <code>self.data</code>. This would greatly improve the readability of the class, and also justify its existence.</p>
<p>If we introduce a <code>__init__()</code> method that requires a parameter, however, we will change the class's API, breaking the compatibility with the code that imports and uses it. Since we want to keep it, we have to devise a way to provide both the advantages of a new, clean class and of a stable API. This is not always perfectly achievable, but in this case the <a href="https://en.wikipedia.org/wiki/Adapter_pattern">Adapter design pattern</a> (also known as Wrapper) can perfectly solve the issue.</p>
<p>The goal is to change the current class to match the new API, and then build a class that wraps the first one and provides the old API. The strategy is not that different from what we did previously, only this time we will deal with classes instead of methods. With a stupendous effort of my imagination I named the new class <code>NewDataStats</code>. Sorry, sometimes you just have to get the job done.</p>
<p>The first things, as happens very often with refactoring, is to duplicate the code, and when we insert new code we need to have tests that justify it. The tests will be the same as before, as the new class shall provide the same functionalities as the previous one, so I just create a new file, called <code>test_newdatastats.py</code> and start putting there the first test <code>test_init()</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">datastats.datastats</span> <span class="kn">import</span> <span class="n">NewDataStats</span>


<span class="n">test_data</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Laith&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Simmons&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£27888&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mikayla&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Henry&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£67137&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Garth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;surname&quot;</span><span class="p">:</span> <span class="s2">&quot;Fields&quot;</span><span class="p">,</span>
        <span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span>
        <span class="s2">&quot;salary&quot;</span><span class="p">:</span> <span class="s2">&quot;£70472&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">test_init</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">NewDataStats</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">test_data</span>
</code></pre></div>

<p>This test doesn't pass, and the code that implements the class is very simple</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">NewDataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</code></pre></div>

<p>Now I can start an iterative process:</p>
<ol>
<li>I will copy one of the tests of <code>DataStats</code> and adapt it to <code>NewDataStats</code></li>
<li>I will copy some code from <code>DataStats</code> to <code>NewDataStats</code>, adapting it to the new API and making it pass the test.</li>
</ol>
<p>At this point iteratively removing methods from <code>DataStats</code> and replacing them with a call to <code>NewDataStats</code> would be overkill. I'll show you in the next section why, and what we can do to avoid  that.</p>
<p>An example of the resulting tests for <code>NewDataStats</code> is the following</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_ages</span><span class="p">():</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">NewDataStats</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">ds</span><span class="o">.</span><span class="n">_ages</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="mi">68</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>
</code></pre></div>

<p>and the code that passes the test is</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_ages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</code></pre></div>

<p>Once finished, I noticed that, as now methods like <code>_ages()</code> do not require an input parameter any more, I can convert them to properties, changing the tests accordingly.</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_ages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>
</code></pre></div>

<p>It is time to replace the methods of <code>DataStats</code> with calls to <code>NewDataStats</code>. We could do it method by method, but actually the only thing that we really need is to replace <code>stats()</code>. So the new code is</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">DataStats</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">):</span>
        <span class="n">nds</span> <span class="o">=</span> <span class="n">NewDataStats</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nds</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">iage</span><span class="p">,</span> <span class="n">isalary</span><span class="p">)</span>
</code></pre></div>

<p>And since all the other methods are not used any more we can safely delete them, checking that the tests do not fail. Speaking of tests, removing methods will make many tests of <code>DataStats</code> fail, so we need to remove them.</p>
<h2 id="step-10-still-room-for-improvement">Step 10 - Still room for improvement<a class="headerlink" href="#step-10-still-room-for-improvement" title="Permanent link">&para;</a></h2>
<p>As refactoring is an iterative process it will often happen that you think you did everything was possible, just to spot later that you missed something. In this case the missing step was spotted by Harun Yasar, who noticed another small code duplication.</p>
<p>The two functions</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_avg_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_salaries</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_avg_age</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ages</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</code></pre></div>

<p>share the same logic, so we can definitely isolate that and call the common code in each function</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_floor_avg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sum_of_numbers</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sum_of_numbers</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_avg_salary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_floor_avg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_salaries</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_avg_age</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_floor_avg</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ages</span><span class="p">))</span>
</code></pre></div>

<p>which passes all the tests and is thus correct.</p>
<p>Whenever I get corrected by someone who read one of my posts and just learned something new I feel so happy, because it means that the message is clear!</p>
<h2 id="final-words">Final words<a class="headerlink" href="#final-words" title="Permanent link">&para;</a></h2>
<p>I hope this little tour of a refactoring session didn't result too trivial, and helped you to grasp the basic concepts of this technique. If you are interested in the subject I'd strongly recommend the classic book by Martin Fowler "Refactoring: Improving the Design of Existing Code", which is a collection of refactoring patterns. The reference language is Java, but the concepts are easily adapted to Python.</p>
<h2 id="updates">Updates<a class="headerlink" href="#updates" title="Permanent link">&para;</a></h2>
<p>2017-07-28: <a href="https://github.com/delirious-lettuce">delirious-lettuce</a> and <a href="https://github.com/superbeckgit">Matt Beck</a> did a very serious proofread and spotted many typos. Thank you both for reading the post and for taking the time to submit the issues!</p>
<p>2020-02-15: <a href="https://github.com/harunyasar">Harun Yasar</a> spotted a missing refactoring in two functions. Thanks!</p>
<h2 id="feedback">Feedback<a class="headerlink" href="#feedback" title="Permanent link">&para;</a></h2>
<p>Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="https://github.com/TheDigitalCatOnline/blog_source/issues">GitHub issues</a> page is the best place to submit corrections.</p>
  </div>


  <section>
    <header>
      <h2>Related Posts</h2>
    </header>
    <div class="paginated-posts">
      <div class="posts">
	<article class="card">
          <a href="/blog/2020/09/21/tdd-in-python-with-pytest-part-5/">
            <img src="/images/tdd-in-python-with-pytest-part-5.jpg" alt="tdd-in-python-with-pytest-part-5" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/21/tdd-in-python-with-pytest-part-5/"><h2>TDD in Python with pytest - Part 5</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-21T10:30:00+02:00">Sep 21, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2021-03-06T19:00:00+00:00">Mar 6, 2021</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/09/17/tdd-in-python-with-pytest-part-4/">
            <img src="/images/tdd-in-python-with-pytest-part-4.jpg" alt="tdd-in-python-with-pytest-part-4" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/17/tdd-in-python-with-pytest-part-4/"><h2>TDD in Python with pytest - Part 4</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-17T11:30:00+02:00">Sep 17, 2020</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/09/15/tdd-in-python-with-pytest-part-3/">
            <img src="/images/tdd-in-python-with-pytest-part-3.jpg" alt="tdd-in-python-with-pytest-part-3" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/15/tdd-in-python-with-pytest-part-3/"><h2>TDD in Python with pytest - Part 3</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-15T08:00:00+02:00">Sep 15, 2020</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/09/11/tdd-in-python-with-pytest-part-2/">
            <img src="/images/tdd-in-python-with-pytest-part-2.jpg" alt="tdd-in-python-with-pytest-part-2" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/11/tdd-in-python-with-pytest-part-2/"><h2>TDD in Python with pytest - Part 2</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-11T10:30:00+02:00">Sep 11, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2023-09-03T19:00:00+02:00">Sep 3, 2023</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/09/10/tdd-in-python-with-pytest-part-1/">
            <img src="/images/tdd-in-python-with-pytest-part-1.jpg" alt="tdd-in-python-with-pytest-part-1" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/10/tdd-in-python-with-pytest-part-1/"><h2>TDD in Python with pytest - Part 1</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-10T10:30:00+02:00">Sep 10, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2023-09-03T19:00:00+02:00">Sep 3, 2023</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2016/09/27/python-mocks-a-gentle-introduction-part-2/">
            <img src="/images/python-mocks.jpg" alt="python-mocks" />
          </a>
          <div class="body">
            <a href="/blog/2016/09/27/python-mocks-a-gentle-introduction-part-2/"><h2>Python Mocks: a gentle introduction - Part 2</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/decorators/" class="tag">decorators</a>
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python2/" class="tag">Python2</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2016-09-27T09:00:00+00:00">Sep 27, 2016</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2016/03/06/python-mocks-a-gentle-introduction-part-1/">
            <img src="/images/python-mocks.jpg" alt="python-mocks" />
          </a>
          <div class="body">
            <a href="/blog/2016/03/06/python-mocks-a-gentle-introduction-part-1/"><h2>Python Mocks: a gentle introduction - Part 1</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/decorators/" class="tag">decorators</a>
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python2/" class="tag">Python2</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2016-03-06T18:00:00+01:00">Mar 6, 2016</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2019-02-27T23:30:00+00:00">Feb 27, 2019</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2015/05/13/python-oop-tdd-example-part1/">
            <img src="/images/python-oop-tdd.jpg" alt="python-oop-tdd" />
          </a>
          <div class="body">
            <a href="/blog/2015/05/13/python-oop-tdd-example-part1/"><h2>A simple example of Python OOP development (with TDD) - Part 1</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2015-05-13T17:00:00+01:00">May 13, 2015</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2022-11-26T16:00:00+00:00">Nov 26, 2022</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2018/12/20/cabook/">
            <img src="/images/cabook.jpg" alt="cabook" />
          </a>
          <div class="body">
            <a href="/blog/2018/12/20/cabook/"><h2>Clean Architectures in Python: the book</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python2/" class="tag">Python2</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
		<a href="/categories/architectures/" class="tag">architectures</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2018-12-20T08:00:00+01:00">Dec 20, 2018</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2021-08-22T08:00:00+00:00">Aug 22, 2021</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/">
            <img src="/images/clean-architectures.jpg" alt="clean-architectures" />
          </a>
          <div class="body">
            <a href="/blog/2016/11/14/clean-architectures-in-python-a-step-by-step-example/"><h2>Clean architectures in Python: a step-by-step example</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python2/" class="tag">Python2</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/architectures/" class="tag">architectures</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2016-11-14T19:00:00+00:00">Nov 14, 2016</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2021-09-24T12:00:00+00:00">Sep 24, 2021</time></p>
	    </div>
          </div>
	</article>
      </div>
    </div>
  </section>
  
</div>

      </div>
    </div>
    <script src="/theme/js/packed.js?46a8f903"></script>

  </body>
</html>