<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>The Digital Cat - A game of tokens: write an interpreter in Python with TDD - Part 1</title>
    <meta charset="utf-8" />
    <meta http-equiv='content-language' content='en-gb'>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="A blog featuring in-depth posts about Python, Scala, TDD, devops, security and all things development">
<meta name="description" content="How to write a programming language in Python, a TDD game">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@thedigicat" />
<meta name="twitter:title" content="A game of tokens: write an interpreter in Python with TDD - Part 1" />
<meta name="twitter:description" content="How to write a programming language in Python, a TDD game" />
<meta name="twitter:image" content="https://www.thedigitalcatonline.com/images/a-game-of-tokens-1.jpg" />
    <script src="https://kit.fontawesome.com/15214b60ba.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400;1,600&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="/theme/css/main.min.css?f6765de3">
    <link href="/images/global/favicon.jpg" rel="icon">
    
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74364524-1"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     
     gtag('config', 'UA-74364524-1');
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZ55XG1KGG"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());
     
     gtag('config', 'G-FZ55XG1KGG');
    </script>
  </head>

  <body class="preload">
    <div class="container">
      <div class="sidebar navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
    <li class="link"><a href="/archives/index.html">Archives</a></li>
  </ul>
</div></nav>
<section>
  <article class="card">
    <a href="https://www.thedigitalcat.academy/freebie-first-class-objects">
      <img src="/images/first-class-objects-in-python.jpg" />
    </a>
    <div class="body">
      <h2>First-class objects in Python</h2>
      <p>Higher-order functions, wrappers, and factories</p>
      <div class="actions">
        <a class="action" href="https://www.thedigitalcat.academy/freebie-first-class-objects">Get your FREE copy</a>
      </div>
    </div>
  </article>
</section>
<section>
  <header>
    <h2>Tags</h2>
  </header>
<ul class="tags">
    <li class="tag tag-size-3">
      <a title="Posts about algorithms" href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about amiga" href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about AMQP" href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about architecture" href="/categories/architecture/">architecture</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about architectures" href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about assembly" href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about AWS" href="/categories/aws/">AWS</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about big data" href="/categories/big-data/">big data</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about blogging" href="/categories/blogging/">blogging</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about C" href="/categories/c/">C</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Clojure" href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about compilers" href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about concurrent programming" href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about cryptography" href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about decorators" href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about design" href="/categories/design/">design</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about devops" href="/categories/devops/">devops</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about distributed systems" href="/categories/distributed-systems/">distributed systems</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Django" href="/categories/django/">Django</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Docker" href="/categories/docker/">Docker</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about ed25519" href="/categories/ed25519/">ed25519</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about editor" href="/categories/editor/">editor</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Emacs" href="/categories/emacs/">Emacs</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Erlang" href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Flask" href="/categories/flask/">Flask</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about functional programming" href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about generators" href="/categories/generators/">generators</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Git" href="/categories/git/">Git</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about HTML" href="/categories/html/">HTML</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about HTTP" href="/categories/http/">HTTP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about infrastructure" href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about JavaScript" href="/categories/javascript/">JavaScript</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Lambda" href="/categories/lambda/">Lambda</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about M68000" href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Markdown" href="/categories/markdown/">Markdown</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Mau" href="/categories/mau/">Mau</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaclasses" href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaprogramming" href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about networking" href="/categories/networking/">networking</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Notebook" href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about OOP" href="/categories/oop/">OOP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about operating systems" href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about pelican" href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Pika" href="/categories/pika/">Pika</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Postage" href="/categories/postage/">Postage</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Postgres" href="/categories/postgres/">Postgres</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about pytest" href="/categories/pytest/">pytest</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python" href="/categories/python/">Python</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Python2" href="/categories/python2/">Python2</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python3" href="/categories/python3/">Python3</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about RabbitMQ" href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about refactoring" href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about retroprogramming" href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about RSA" href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Scala" href="/categories/scala/">Scala</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSH" href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSL" href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about TDD" href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Terraform" href="/categories/terraform/">Terraform</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about testing" href="/categories/testing/">testing</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about tools" href="/categories/tools/">tools</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about versioning" href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about video" href="/categories/video/">video</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about WWW" href="/categories/www/">WWW</a>
    </li>
</ul></section>
<section>
  <header>
    <h2>Categories</h2>
  </header>
<ul>
  <li><a href="/category/programming/">Programming</a></li>
  <li><a href="/category/projects/">Projects</a></li>
  <li><a href="/category/retro/">Retro</a></li>
</ul></section>
<section>
  <header>
    <h2>Feeds</h2>
  </header>
<ul>
  <li><i class="fas fa-rss" aria-hidden="true"></i> <a href="/atom.xml">All posts</a></li>


  <li><i class="fas fa-rss" aria-hidden="true"></i> <a href="/category/programming/atom.xml">All posts in category: Programming</a></li>
</ul></section>
<section>
  <header>
    <h2>Get in touch</h2>
  </header>
  <ul class="contact">
    <li><i class="fab fa-twitter" aria-hidden="true"></i> <a href="https://twitter.com/thedigicat">Twitter</a></li>
    <li><i class="fab fa-github" aria-hidden="true"></i> <a href="https://github.com/TheDigitalCatOnline">GitHub</a></li>
  </ul>
</section>      </div>
      <div class="page">
	<header class="primary" >
	  <button type="button">
	    <i class="fas fa-bars"></i>
	  </button>
	  <p>The Digital Cat</p>
	</header>
	<div class="mobile-menu navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
    <li class="link"><a href="/archives/index.html">Archives</a></li>
  </ul>
</div></nav>
<section>
  <header>
    <h2>Categories</h2>
  </header>
<ul>
  <li><a href="/category/programming/">Programming</a></li>
  <li><a href="/category/projects/">Projects</a></li>
  <li><a href="/category/retro/">Retro</a></li>
</ul></section>
<section>
  <header>
    <h2>Tags</h2>
  </header>
<ul class="tags">
    <li class="tag tag-size-3">
      <a title="Posts about algorithms" href="/categories/algorithms/">algorithms</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about amiga" href="/categories/amiga/">amiga</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about AMQP" href="/categories/amqp/">AMQP</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about architecture" href="/categories/architecture/">architecture</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about architectures" href="/categories/architectures/">architectures</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about assembly" href="/categories/assembly/">assembly</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about AWS" href="/categories/aws/">AWS</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about big data" href="/categories/big-data/">big data</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about blogging" href="/categories/blogging/">blogging</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about C" href="/categories/c/">C</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Clojure" href="/categories/clojure/">Clojure</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about compilers" href="/categories/compilers/">compilers</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about concurrent programming" href="/categories/concurrent-programming/">concurrent programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about cryptography" href="/categories/cryptography/">cryptography</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about decorators" href="/categories/decorators/">decorators</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about design" href="/categories/design/">design</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about devops" href="/categories/devops/">devops</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about distributed systems" href="/categories/distributed-systems/">distributed systems</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Django" href="/categories/django/">Django</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Docker" href="/categories/docker/">Docker</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about ed25519" href="/categories/ed25519/">ed25519</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about editor" href="/categories/editor/">editor</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Emacs" href="/categories/emacs/">Emacs</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Erlang" href="/categories/erlang/">Erlang</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Flask" href="/categories/flask/">Flask</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about functional programming" href="/categories/functional-programming/">functional programming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about generators" href="/categories/generators/">generators</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Git" href="/categories/git/">Git</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about HTML" href="/categories/html/">HTML</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about HTTP" href="/categories/http/">HTTP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about infrastructure" href="/categories/infrastructure/">infrastructure</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about JavaScript" href="/categories/javascript/">JavaScript</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Lambda" href="/categories/lambda/">Lambda</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about M68000" href="/categories/m68000/">M68000</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Markdown" href="/categories/markdown/">Markdown</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Mau" href="/categories/mau/">Mau</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaclasses" href="/categories/metaclasses/">metaclasses</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about metaprogramming" href="/categories/metaprogramming/">metaprogramming</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about networking" href="/categories/networking/">networking</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Notebook" href="/categories/notebook/">Notebook</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about OOP" href="/categories/oop/">OOP</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about operating systems" href="/categories/operating-systems/">operating systems</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about pelican" href="/categories/pelican/">pelican</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Pika" href="/categories/pika/">Pika</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about Postage" href="/categories/postage/">Postage</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Postgres" href="/categories/postgres/">Postgres</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about pytest" href="/categories/pytest/">pytest</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python" href="/categories/python/">Python</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Python2" href="/categories/python2/">Python2</a>
    </li>
    <li class="tag tag-size-1">
      <a title="Posts about Python3" href="/categories/python3/">Python3</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about RabbitMQ" href="/categories/rabbitmq/">RabbitMQ</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about refactoring" href="/categories/refactoring/">refactoring</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about retroprogramming" href="/categories/retroprogramming/">retroprogramming</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about RSA" href="/categories/rsa/">RSA</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about Scala" href="/categories/scala/">Scala</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSH" href="/categories/ssh/">SSH</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about SSL" href="/categories/ssl/">SSL</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about TDD" href="/categories/tdd/">TDD</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about Terraform" href="/categories/terraform/">Terraform</a>
    </li>
    <li class="tag tag-size-2">
      <a title="Posts about testing" href="/categories/testing/">testing</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about tools" href="/categories/tools/">tools</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about versioning" href="/categories/versioning/">versioning</a>
    </li>
    <li class="tag tag-size-4">
      <a title="Posts about video" href="/categories/video/">video</a>
    </li>
    <li class="tag tag-size-3">
      <a title="Posts about WWW" href="/categories/www/">WWW</a>
    </li>
</ul></section>	</div>
	
<div class="page-content">
  <header>
    <h1>A game of tokens: write an interpreter in Python with TDD - Part 1</h1>
    <div class="post-info">
      <p>By Leonardo Giordani - <i class="fas fa-calendar-alt"></i> <time datetime="2017-05-09T23:00:00+01:00"> 09/05/2017</time> <i class="fas fa-edit"></i> Updated on <time datetime="2020-08-05T11:00:00+00:00">Aug 5, 2020</time></p>
      <p class="tags">
	<a class="tag category" href="/category/programming/" title="All posts in category Programming">Programming</a>
	<a class="tag" href="/categories/pytest/">pytest</a>
	<a class="tag" href="/categories/python/">Python</a>
	<a class="tag" href="/categories/python3/">Python3</a>
	<a class="tag" href="/categories/tdd/">TDD</a>
	<a class="tag" href="/categories/testing/">testing</a>
	<a class="tag" href="/categories/compilers/">compilers</a>
      </p>
      <p class="share">Share on: <span><a class="" href="https://twitter.com/intent/tweet?text=A%20game%20of%20tokens%3A%20write%20an%20interpreter%20in%20Python%20with%20TDD%20-%20Part%201&url=https%3A//www.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/&via=thedigicat&hashtags=pytest,python,python3,tdd,testing,compilers" target="_blank" title="Share on Twitter"><i class="fab fa-twitter"></i> Twitter</a></span>
<span><a class="" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//www.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/&title=A%20game%20of%20tokens%3A%20write%20an%20interpreter%20in%20Python%20with%20TDD%20-%20Part%201&summary=How%20to%20write%20a%20programming%20language%20in%20Python%2C%20a%20TDD%20game&source=https%3A//www.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/" target="_blank" title="Share on LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a></span>
<span><a class="" href="https://news.ycombinator.com/submitlink?t=A%20game%20of%20tokens%3A%20write%20an%20interpreter%20in%20Python%20with%20TDD%20-%20Part%201&u=https%3A//www.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news"></i> HackerNews</a></span>
<span><a class="" href="mailto:?subject=A%20game%20of%20tokens%3A%20write%20an%20interpreter%20in%20Python%20with%20TDD%20-%20Part%201&amp;body=https%3A//www.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/" target="_blank" title="Share via Email"><i class="fas fa-envelope"></i> Email</a></span>
<span><a class="" href="https://www.reddit.com/submit?url=https%3A//www.thedigitalcatonline.com/blog/2017/05/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-1/&title=A%20game%20of%20tokens%3A%20write%20an%20interpreter%20in%20Python%20with%20TDD%20-%20Part%201" target="_blank" title="Share via Reddit"><i class="fab fa-reddit"></i> Reddit</a></span></p>    
    </div>
  </header>
  
  <div class="post-content">
    <h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>Writing an interpreter or a compiler is usually considered one of the greatest goals that a programmer can achieve, and with good reason. I do not believe the importance of going through this experience is primarily due to its difficulty, though. After all, writing an efficient compiler is difficult, but the same is true for a good web framework, or a feature-rich editor.</p>
<p>Being able to write an interpreter is a significant skill mainly because of its recursive (or self-referring) nature. Think about it: you use a language to write a new language. And this new language, if it becomes sufficiently rich, can eventually be used to create its own compiler.</p>
<p><strong>A language can be used to write the program that executes that same language.</strong></p>
<p>Didn't this last sentence fire you with enthusiasm? It makes me eager to start!</p>
<p>Compilers have been the subject of academic research since the 50s, with the works of <a href="https://en.wikipedia.org/wiki/Grace_Hopper">Hopper</a> and <a href="https://en.wikipedia.org/wiki/Alick_Glennie">Glennie</a>, so trying to provide an overview in a few lines is basically impossible. I highly recommend you to check the online resources listed at the bottom of the post if you are seriously interested in the matter.</p>
<p>In this series of posts I want to try an experiment. I want to guide you through the creation of a simple interpreter in Python using a pure TDD (Test-Driven Development) approach. The posts will be structured like a game, where every level is represented by a new test that I will add to the suite. If you are not confident with TDD, you will find more on it in the specific section.</p>
<p>Following this series you will learn about Python, compilers, interpreters, parsers, lexers, test-driven development, refactoring, coverage, regular expressions, classes, context managers. Wow, that's a lot!</p>
<p>Are you ready to start?</p>
<h2 id="on-the-tdd-game">On the TDD game<a class="headerlink" href="#on-the-tdd-game" title="Permanent link">&para;</a></h2>
<p>This series of posts will introduce you to TDD with a sort of game. I'll give you the test, and you are supposed to write something that passes that test, finishing the level. <strong>Update</strong>: I decided to move solutions into the same post where the challenge is given, you will find them in specific sections named "Solution" after each level.</p>
<p>My best advice for the TDD game is: remember that the easiest solution for a test that requires the output <code>A</code> is to write a function that returns exactly <code>A</code>.</p>
<p><strong>Beautiful is better than ugly, but ugly and tested is better than beautiful and untested.</strong></p>
<h2 id="about-the-language">About the language<a class="headerlink" href="#about-the-language" title="Permanent link">&para;</a></h2>
<p>At the time of writing the language we are going to implement is a simple calculator with support for <strong>integer</strong> and <strong>floats</strong>, <strong>binary operators</strong> (addition, subtraction, multiplication, division, and power), <strong>unary operators</strong> (negation), <strong>nested expressions</strong> (parentheses) and <strong>variables</strong>.</p>
<p>The name <strong>smallcalc</strong> is a homage to one of the most innovative and influential languages ever conceived: <a href="https://en.wikipedia.org/wiki/Smalltalk">Smalltalk</a>.</p>
<p>I do not know if the final version will be something richer, it depends on how much fun you will find in the series. So, if you are interested, just ask! You can drop a line of appreciation <a href="https://twitter.com/thedigicat">on Twitter</a>.</p>
<p>At the time of writing, then, the language grammar is</p>
<div class="highlight"><pre><span></span><code>factor : (&#39;+&#39; | &#39;-&#39;) factor | &#39;(&#39; expression &#39;)&#39; | variable | number
power : factor [ &#39;^&#39; power ]*
term : power [ (&#39;*&#39; | &#39;/&#39;) term ]*
expression : term [ (&#39;*&#39; | &#39;/&#39;) expression ]*
assignment : variable &#39;=&#39; expression
line : assignment | expression
</code></pre></div>

<p>The syntax of the grammar is pretty self-explanatory if you have some programming background. If you want to know more about grammars like the one above start from the links in the resources section.</p>
<h2 id="tdd-and-refactoring">TDD and refactoring<a class="headerlink" href="#tdd-and-refactoring" title="Permanent link">&para;</a></h2>
<p>If you already know what TDD is feel free to skip this section.</p>
<p><strong>TDD</strong> means <strong>Test-Driven Development</strong>, and in short it is a programming methodology that requires you to write a test for a feature before implementing the feature itself. Much has been said on the benefits of TDD elsewhere. I personally think it is one of the most effective ways to work on a programming task, and something that every programmer should know. I wrote a post on TDD with Python that you can find <a href="https://www.thedigitalcatonline.com/blog/2015/05/13/python-oop-tdd-example-part1/">here</a>.</p>
<p>A <strong>test</strong>, in TDD, is code that uses the code you are going to develop. You will start with a project skeleton and add the tests I will present in the posts one at a time. Once you add the test, you have to write the code that passes the test. Your code doesn't need to be beautiful or smart, it just needs to pass the test. Then you can move to the following test and start the cycle again.</p>
<p>After adding some tests you can start considering <strong>refactoring</strong>, which means changing the existing code in order to make it more beautiful, simpler or better organised. Every change has to be tested against the existing battery of tests. If the tests do not fail your change is correct, at least in terms of the behaviour that the tests are checking.</p>
<p><strong>Coverage</strong> is the check of how much of your code is covered by your tests. We call some code "covered" by a test if executing the test makes that code run. So, for example, if you have a test (an <code>if</code> block) you should write two tests. One to cover the first option, and another to cover the second one. If you work with a strict TDD methodology your coverage is going to be always 100%, because you wrote just the code that makes the tests pass.</p>
<p>You can find more on TDD on this blog <a href="/categories/tdd/">here</a>.</p>
<h2 id="about-the-project">About the project<a class="headerlink" href="#about-the-project" title="Permanent link">&para;</a></h2>
<p>The main components of our interpreter are the following:</p>
<ul>
<li><strong>Token</strong>: a token is the minimal element of the language syntax, like an integer (not a digit, but a group of them), a name (not a letter but a group of them), or a symbol (like the mathematical operations).</li>
<li><strong>Buffer</strong>: the input text (the program) has to be managed by a specific component. Parsing the input text has many requirements, among them being able to read upcoming parts of the text and to move back, or to move to specific locations.</li>
<li><strong>Lexer</strong>: this is the first component of standard interpreters. Its job is to divide the stream of input characters into meaningful chunks called tokens. It will process a string like "123 + x" and output three tokens: an integer, a symbol and a variable name.</li>
<li><strong>Parser</strong>: the second component of standard interpreters. It analyses the stream of tokens produced by the lexer and produces a data structure that represents the whole program.</li>
<li><strong>Visitor</strong>: the output of the parser is processed by a component that will either write the equivalent in another language or execute it.</li>
<li><strong>Command Line Interface (CLI)</strong>: the whole stack can be directly used by a REPL (Read, Evaluate, Print Loop), a command line interface similar to the one Python provides. There each line is lexed, parsed, and visited, and the result is printed immediately.</li>
</ul>
<p>I will provide two classes: <code>Token</code> and <code>TextBuffer</code>. These will avoid you spending too much time to create the basic tools, and allow you to get straight into the game. Since those classes come obviously with their own test suite you are free to develop them on your own. You should however start from the same tests that I used, otherwise your interface might end up being incompatible witht he rest of the project.</p>
<h2 id="initial-setup">Initial setup<a class="headerlink" href="#initial-setup" title="Permanent link">&para;</a></h2>
<p>I prepared <a href="https://github.com/lgiordani/smallcalc">this repository</a>, which contains everything you need to start the project.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/lgiordani/smallcalc.git
</code></pre></div>

<p>Once you cloned the repository, set up a Python virtual environment using your favourite method/tool and install the testing requirements</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>-r<span class="w"> </span>requirements/test.txt
</code></pre></div>

<p>At this point you should be able to run the test suite. For this project we are going to use <a href="http://www.pytest.org">pytest</a>, so the command line is</p>
<div class="highlight"><pre><span></span><code>pytest<span class="w"> </span>-svv
</code></pre></div>

<p>or, if you want to check your code coverage,</p>
<div class="highlight"><pre><span></span><code>pytest<span class="w"> </span>-svv<span class="w">  </span>--cov-report<span class="w"> </span>term-missing<span class="w"> </span>--cov<span class="o">=</span>smallcalc<span class="w"> </span>
</code></pre></div>

<h2 id="tokens">Tokens<a class="headerlink" href="#tokens" title="Permanent link">&para;</a></h2>
<p>The first class that I provide to start working on our interpreter is <code>Token</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Token(</span><span class="si">{}</span><span class="s2">, &#39;</span><span class="si">{}</span><span class="s2">&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;Token(</span><span class="si">{}</span><span class="s2">, &#39;</span><span class="si">{}</span><span class="s2">&#39;, line=</span><span class="si">{}</span><span class="s2">, col=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<p>This represents one syntax unit in which we divide the input text. The token can contain information about its original position, which can be useful in case of syntax errors to print meaningful messages for the user. The class implements the method <code>__eq__</code> to provide comparison between tokens.</p>
<p>The value of a token is always a string, and shall be converted into a different type by an external object according to the value that the token assumes. For example the string <code>'123'</code> can be interpreted as an integer, but could also be the name of a variable if our language supports such a feature.</p>
<p>Remember that everything you find in this class has been introduced to make one or more tests pass, so check the test suite to understand how the object can be used.</p>
<h2 id="buffer">Buffer<a class="headerlink" href="#buffer" title="Permanent link">&para;</a></h2>
<p>The second element that you will find in the initial setup is the class <code>TextBuffer</code>, that provides a very basic manager for an input text file</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">EOLError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; Signals that the buffer is reading after the end of a line.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">EOFError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; Signals that the buffer is reading after the end of the text.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">TextBuffer</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">text</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EOFError</span><span class="p">(</span>
                <span class="s2">&quot;EOF reading line </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_char</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EOLError</span><span class="p">(</span>
                <span class="s2">&quot;EOL reading column </span><span class="si">{}</span><span class="s2"> at line </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">next_char</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">EOLError</span><span class="p">(</span>
                <span class="s2">&quot;EOL reading column </span><span class="si">{}</span><span class="s2"> at line </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_line</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">:]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">newline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">+=</span> <span class="n">steps</span>

    <span class="k">def</span> <span class="nf">goto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">line</span><span class="p">,</span> <span class="n">column</span>
</code></pre></div>

<p>As happened for the <code>Token</code> class, you can read the tests to understand how to use the class. Basically, however, the class can <code>load</code> an input text and extract the <code>current_line</code>, the <code>current_char</code>, and the <code>next_char</code>. You can also <code>skip</code> a given number of characters, <code>goto</code> a given position, extract the current <code>position</code> and read the <code>tail</code>, which is the remaining text from the current position to the end of the line.</p>
<p>This class has not been optimized or designed to manage big files or continuous streams of text. This is perfectly fine for our current project, but be aware that for a real compiler you might want to implement something more powerful.</p>
<h2 id="cli">CLI<a class="headerlink" href="#cli" title="Permanent link">&para;</a></h2>
<p>The third element I provide is a simple REPL (<a href="https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop">Read–eval–print loop</a>) that at the moment just echoes any text you will input and gracefully exit when we press Ctrl+D. There are and there will be no tests for the CLI. Testing endpoints like this is complex and not always worth the effort, as in this case.</p>
<p>The command line can be run from the project main directory with</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>cli.py
</code></pre></div>

<h2 id="level-1-end-of-file">Level 1 - End of file<a class="headerlink" href="#level-1-end-of-file" title="Permanent link">&para;</a></h2>
<p><em>"End? No, the journey doesn't end here."</em> - The Lord of the Rings: The Return of the King (2003)</p>
<p>The first thing a Lexer shall be able to do is to load and process an empty text. This should return an <code>EOF</code> (<code>End Of File</code>) token. <code>EOF</code> is used to signal that the input buffer has ended and that there is no more text to process.</p>
<p>The method <code>get_tokens</code> returns all the tokens of the input stream in a single list.</p>
<p>Add this code to <code>tests/test_calc_lexer.py</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">tok</span> <span class="k">as</span> <span class="n">token</span>
<span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_lexer</span> <span class="k">as</span> <span class="n">clex</span>


<span class="k">def</span> <span class="nf">test_get_tokens_understands_eof</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p>To avoid misleading errors you should also create the empty file <code>smallcalc/calc_lexer.py</code>, as without that file pytest will raise an <code>ImportError</code>.</p>
<p>This is our first test, and if you run the test suite now you will see that it fails. This is expected, as there is no code to pass the test.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>pytest<span class="w"> </span>-svv<span class="w">  </span>--cov-report<span class="w"> </span>term-missing<span class="w"> </span>--cov<span class="o">=</span><span class="nv">smallcalc</span>
<span class="o">==================================</span><span class="w"> </span><span class="nv">FAILURES</span><span class="w"> </span><span class="o">===================================</span>
_______________________<span class="w"> </span>test_get_tokens_understands_eof<span class="w"> </span>_______________________

<span class="w">    </span>def<span class="w"> </span>test_get_tokens_understands_eof<span class="o">()</span>:
&gt;<span class="w">       </span><span class="nv">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>clex.CalcLexer<span class="o">()</span>
E<span class="w">       </span>AttributeError:<span class="w"> </span>module<span class="w"> </span><span class="s1">&#39;smallcalc.calc_lexer&#39;</span><span class="w"> </span>has<span class="w"> </span>no<span class="w"> </span>attribute<span class="w"> </span><span class="s1">&#39;CalcLexer&#39;</span>

tests/test_calc_lexer.py:6:<span class="w"> </span><span class="nv">AttributeError</span>
<span class="o">=====================</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>failed,<span class="w"> </span><span class="m">29</span><span class="w"> </span>passed<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">0</span>.08<span class="w"> </span><span class="nv">seconds</span><span class="w"> </span><span class="o">=====================</span>
</code></pre></div>

<p>Implement now a class <code>CalcLexer</code> in the file <code>smallcalc/calc_lexer.py</code> that makes the test pass. Remember that you just need the code to pass this test. So do not implement complex systems now and go for the simplest solution (hint: the test expects that specific output).</p>
<p>The <code>EOF</code> constant can be a simple string with the value <code>'EOF'</code>.</p>
<p>It is worth executing the test suite with coverage (check the command line above), which will tell you if you over-engineered your code. You should aim for 100% coverage, always.</p>
<hr>
<h3 id="solution">Solution<a class="headerlink" href="#solution" title="Permanent link">&para;</a></h3>
<p>To pass the test, the class <code>CalcLexer</code> can use the provided <code>text_buffer.TextBuffer</code> class, that exposes a method <code>load</code> and wrap it in <code>CalcLexer.load</code>. The test is not providing any input so the easiest solution is just to return the required token. The test requires us to implement the method <code>get_tokens</code>, but I preferred to isolate the code in a method called <code>get_token</code> and to call the latter from <code>get_tokens</code>. The file <code>smallcalc/calc_lexer.py</code> is then</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">text_buffer</span>
<span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">tok</span> <span class="k">as</span> <span class="n">token</span>

<span class="n">EOF</span> <span class="o">=</span> <span class="s1">&#39;EOF&#39;</span>


<span class="k">class</span> <span class="nc">CalcLexer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span> <span class="o">=</span> <span class="n">text_buffer</span><span class="o">.</span><span class="n">TextBuffer</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_token</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_token</span>

    <span class="k">def</span> <span class="nf">get_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">()]</span>
</code></pre></div>

<hr>
<p>You can see here in practice what I mentioned in the introduction about TDD. The method <code>get_token</code> returns a hardcoded <code>token.Token(EOF)</code>, because <em>that is enough to pass the test</em>. It is not enough to be a good Lexer, but if we write and pass the right tests, this will happen in time. Be smart, be strict: write the minimal code needed to pass the test.</p>
<p>Being really strict, however, this solution is already over-engineered. The code</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">EOF</span><span class="p">)]</span>
</code></pre></div>

<p>would be enough to pass the test. It would also be the first thing we change as soon as we add another test. So, let me amend the previous advice: be strict, with a pinch of salt.</p>
<h2 id="level-2-single-digit-integers">Level 2 - Single digit integers<a class="headerlink" href="#level-2-single-digit-integers" title="Permanent link">&para;</a></h2>
<p><em>"You're missing just a couple of digits there."</em> - Iron Man (2008)</p>
<p>The requirement for this section is</p>
<div class="highlight"><pre><span></span><code># The only accepted value for the input is one single digit between 0 and 9
integer: [0-9]
</code></pre></div>

<h3 id="lexer">Lexer<a class="headerlink" href="#lexer" title="Permanent link">&para;</a></h3>
<p>Since a calculator has to deal with numbers let us implement support for integers (we will add floating point numbers later). The first thing that we need is to recognise single-digit integers. This is the test that you have to add to <code>tests/test_calc_lexer.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_token_understands_integers</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>
</code></pre></div>

<p>Note that here we are testing <code>get_token</code> and not <code>get_tokens</code>. This method will come handy later, so it is worth testing it here. As soon as that works you can test the behaviour of <code>get_tokens</code></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_tokens_understands_integers</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOL</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p>Please note that now the lexer shall output both an <code>EOF</code> and an <code>EOL</code> token, as the current line of code ends. The biggest issue you have to face here is that when you recognise a token then you have to skip it in the source text.</p>
<p>After this test you may end up with some code duplication, as <code>get_token</code> and <code>get_tokens</code> perform similar tasks. If you haven't already, please call the former from the latter. It could also be worth doing some refactoring. Remember: you can confidently change your code, because as long as the tests pass your changes are correct! This is the true power of TDD.</p>
<p>If you refactor the code creating helper methods you should make them "private" by prefixing their name with an underscore. This also means that you do not need to test them, in principle (watch <a href="https://www.youtube.com/watch?v=URSWYvyc42M">this talk</a> by Sandy Metz on this subject).</p>
<h3 id="parser">Parser<a class="headerlink" href="#parser" title="Permanent link">&para;</a></h3>
<p>Now that we have a working lexer that recognises integers let us work on the parser. This has to use the lexer to process a text and produce a tree of nodes that represent the syntactic structure of the processed code. Don't worry if it seems extremely complex, it is actually pretty simple if you follow the tests.</p>
<p>Edit the <code>tests/test_calc_parser.py</code> file and insert this code</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_parser</span> <span class="k">as</span> <span class="n">cpar</span>


<span class="k">def</span> <span class="nf">test_parse_integer</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;5&quot;</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_integer</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">5</span>
    <span class="p">}</span>
</code></pre></div>

<p>The <code>node</code> variable is an instance of a specific class that contains integers, <code>IntegerNode</code> (but you are free to name it as you want, as this is not tested). Please note that this class doesn't consider the value as a string any more, but as a proper (Python) integer (<code>'value': 5</code>). Now edit the file <code>smallcalc/calc_parser.py</code> and write some code that passes the test.</p>
<p>Does it work? Well, you just wrote your first parser! Congratulations! From here to something that understands C++ or Python the journey is pretty long, but the initial steps are promising.</p>
<h3 id="visitor">Visitor<a class="headerlink" href="#visitor" title="Permanent link">&para;</a></h3>
<p>Let us consider the visitor, now. This is the run-time component of our language, the part that actually runs through the tree of nodes and executes it. This part, thus, is where most of the actual behaviour of the language happens. For instance, the fact that the symbol "+" actually sums integers is because the visitor implements that operation.</p>
<p>This can seem a trivial consideration, but if you think about the division between integers you immediately understand that the visitor has a great responsibility. Does the symbol <code>/</code> divide integers with or without floating point math? Python 3, for instance, opted for a floating point division, and introduced the <code>//</code> operator for the integer version of the operation, but other languages behave differently.</p>
<p>I'll discuss this in more detail later, when we will implement mathematical operations. For the time being, let us create the <code>tests/test_calc_visitor.py</code> file and introduce the following test</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_visitor</span> <span class="k">as</span> <span class="n">cvis</span>


<span class="k">def</span> <span class="nf">test_visitor_integer</span><span class="p">():</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">12</span>
    <span class="p">}</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">cvis</span><span class="o">.</span><span class="n">CalcVisitor</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">)</span>
</code></pre></div>

<p>As you can see, at this stage the visitor has a trivial job, which is to just return the value and the type of the number that it finds in the tree. Note that the visitor provides a method <code>visit</code> which is type agnostic (i.e. it doesn't care about the type of the node). This is correct, as the visitor has to traverse the whole tree recursively and to react to the different nodes without a previous knowledge of what it should expect.</p>
<p>As simple as the visitor can be, now we can make our CLI interface use the parser and the visitor to understand and execute one simple command, which is to parse a single-digit integer and print it with its type. Change the <code>cli.py</code> file to </p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_parser</span> <span class="k">as</span> <span class="n">cpar</span>
<span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_visitor</span> <span class="k">as</span> <span class="n">cvis</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">cvis</span><span class="o">.</span><span class="n">CalcVisitor</span><span class="p">()</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;smallcalc :&gt; &#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_integer</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">())</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bye!&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">continue</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>Test it to check that everything works. If your code passes the tests I gave you, the result is guaranteed.</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>cli.py<span class="w"> </span>
smallcalc<span class="w"> </span>:&gt;<span class="w"> </span><span class="m">3</span>
<span class="o">(</span><span class="m">3</span>,<span class="w"> </span><span class="s1">&#39;integer&#39;</span><span class="o">)</span>
</code></pre></div>

<p>Let me recap what we just created. We wrote a lexer, which is a component that splits the input text in different tokens with a meaning, and we instructed it to react to single-digits integers. Then, we created a parser, which is the component that tries to make sense of several tokens put together, applying syntactical rules. Last, the visitor runs through the output of the parser and actually performs the actions that the grammar describes. All this to just print out an integer? Seems overkill! It is, actually, but there is a lot to come, and this separation of levels will come handy.</p>
<hr>
<h3 id="solution_1">Solution<a class="headerlink" href="#solution_1" title="Permanent link">&para;</a></h3>
<p>The two functions <code>get_token</code> and <code>get_tokens</code> have to evolve to deal with the new requirements, and to avoid having too much code in a single function I created some private helpers (where "private" has the Python meaning of "please don't use them").</p>
<p>The idea behind <code>get_tokens</code> is to call <code>get_token</code> until the <code>EOF</code> token is returned, even though we want the latter to be present in the final result.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="s1">&#39;EOF&#39;</span><span class="p">):</span>
            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>

        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="s1">&#39;EOF&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tokens</span>
</code></pre></div>

<p>Then I decided to make <code>get_token</code> the central hub of my process with the following paradigm: the function tries to extract a specific token (<code>_process_integer</code>, in this case) and to return it; if the token cannot be extracted, the function tries the following one. At the moment I don't have any other type of token, but I will have them soon.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">eof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_eof</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">eof</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eof</span>

        <span class="n">eol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_eol</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">eol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eol</span>

        <span class="n">integer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_integer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">integer</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">integer</span>
</code></pre></div>

<p>The three helpers shall just try to extract and return the token they have been assigned or None. After some refactoring I came up with three functions (two of them as properties) that simplify common tasks. <code>_current_char</code> and <code>_current_line</code> are just wrappers around two attributes of <code>self._text_storage</code>, while <code>_set_current_token_and_skip</code> is a bit more complex and ensures that the <code>_current_token</code> is always up to date.</p>
<div class="highlight"><pre><span></span><code>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_current_char</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">current_char</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_current_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">current_line</span>

    <span class="k">def</span> <span class="nf">_set_current_token_and_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_current_token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="k">return</span> <span class="n">token</span>
</code></pre></div>

<p>Once this functions are in place I can write the actual helpers for the token extraction. The method <code>_process_eol</code> leverages <code>self._text_storage</code>, which raises an <code>EOLError</code> when the end of line has been reached. So all I need to do is to try to get the current char and return <code>None</code> if nothing happens. In case an <code>EOLError</code> exception is raised I run <code>_set_current_token_and_skip</code> with the end of line token.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_process_eol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_char</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">text_buffer</span><span class="o">.</span><span class="n">EOLError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_current_token_and_skip</span><span class="p">(</span>
                <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">EOL</span><span class="p">)</span>
            <span class="p">)</span>
</code></pre></div>

<p>The helper to process the end of file (<code>_process_eof</code>) is exactly like <code>_process_eol</code>, using <code>self._current_line</code> and <code>text_buffer.EOFError</code>.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_process_eof</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_current_line</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">text_buffer</span><span class="o">.</span><span class="n">EOFError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_current_token_and_skip</span><span class="p">(</span>
                <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
            <span class="p">)</span>
</code></pre></div>

<p>At this point of the development the incoming token can only be <code>EOL</code>, <code>EOF</code>, or an integer, so the <code>_process_integer</code> function doesn't need to return <code>None</code>. Therefore, it is sufficient to create an integer token with the current char and return it.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_process_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_current_token_and_skip</span><span class="p">(</span>
            <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_char</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<p>The above methods use two new global variables <code>EOL</code> and <code>INTEGER</code> that are defined at the beginning of the file along with <code>EOF</code></p>
<div class="highlight"><pre><span></span><code><span class="n">EOL</span> <span class="o">=</span> <span class="s1">&#39;EOL&#39;</span>
<span class="n">INTEGER</span> <span class="o">=</span> <span class="s1">&#39;INTEGER&#39;</span>
</code></pre></div>

<p><code>CalcParser</code> is the only class that is tested, but forecasting (actually, knowing) that we are going to manage multiple types of nodes, I isolated the code for the <code>IntegerNode</code> in its own class. There is no need to abstract things further for the time being, so <code>IntegerNode</code> doesn't inherit from any other class.</p>
<p>From a pure TDD point of view this is wrong, because I should have written some tests for the <code>IntegerNode</code> class before writing it. The purpose of this exercise, however is to guide you through the creation of a simple compiler, so tests are already given, and I will turn a blind eye on my own exception to the rule (how convenient!).</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_lexer</span> <span class="k">as</span> <span class="n">clex</span>


<span class="k">class</span> <span class="nc">IntegerNode</span><span class="p">:</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="s1">&#39;integer&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_type</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">CalcParser</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">parse_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">IntegerNode</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</code></pre></div>

<p><code>CalcVisitor</code> is by far the simplest class at the moment, as the only node we are managing is the one with an <code>integer</code> type.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CalcVisitor</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;integer&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
</code></pre></div>

<hr>
<h2 id="level-3-binary-operations-addition">Level 3 - Binary operations: addition<a class="headerlink" href="#level-3-binary-operations-addition" title="Permanent link">&para;</a></h2>
<p><em>"You're about to become a permanent addition to this archaeological find."</em> - Raiders of the Lost Ark (1981)</p>
<p>Let's update the grammar of the language with <code>addsymbol</code> and <code>expression</code></p>
<div class="highlight"><pre><span></span><code>integer: [0-9]

# Label the symbol &#39;+&#39;&#39; with the name &#39;addsymbol&#39;
addsymbol: &#39;+&#39;

# An expression is an integer followed by an addsymbol followed by another integer
expression: integer addsymbol integer
</code></pre></div>

<p>At the moment, our parser doesn't sound like an important component, as its output is just a refurbished version of the lexer one. The visitor, in turn, doesn't really perform any action but to print in a different format what the parser produces.</p>
<p>Let us try to introduce a simple mathematical operation, then, that should spice up our components. The new test for the lexer component (<code>tests/test_calc_lexer.py</code>) is</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_tokens_understands_unspaced_sum_of_integers</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;3+5&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">LITERAL</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOL</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p>Please note that there are no spaces, as our lexer doesn't know how to deal with them yet. As you can see the output is straightforward, so go and change the <code>CalcLexer</code> class to make this tests pass without breaking any of the ones you already wrote. Check for coverage, to spot possible overengineered parts, and if necessary refactor the class to keep methods as simple as possible.</p>
<p>The parser now has a more complex job than before, though not yet really challenging. The test for the parser is</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_parse_expression</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;2+3&quot;</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_expression</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">},</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">},</span>
        <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>I want to resume here the discussion about mathematical operators and the role of the visitor that I started in the previous section. As you can see the expression is a generic binary operator, with a <code>left</code> term, a <code>right</code> term, and an <code>operator</code>. The operator, furthermore, is just a literal which value is the symbol we use for that binary operation.</p>
<p>This parser, thus, is pretty ignorant of the different operations we can perform, giving the whole responsibility to the visitor. We could, however, implement the parser to make it produce something more specific, like for example a <code>binary_sum</code> or <code>addition</code> node, which represents only the addition, and which wouldn't need the <code>'operator'</code> key, as it is implicit in the node type.</p>
<p>The amount of work done by the parser and by the visitor is a peculiarity of the specific language or program, so feel free to experiment. For the moment you have to stick to one solution as you are guided by the tests that I wrote, but as soon as you grasped the concepts and start writing a new language, you will be free to implement each component as you prefer.</p>
<p>Finally, the visitor shall implement the actual mathematical operation. The test is</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_visitor_expression_sum</span><span class="p">():</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">},</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">},</span>
        <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">cvis</span><span class="o">.</span><span class="n">CalcVisitor</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">)</span>
</code></pre></div>

<p>As soon as you changed the method <code>visit</code> to deal with <code>'expression'</code> nodes, you can test the new syntax in the CLI. Since we changed <code>visit</code> internally, that part of the CLI doesn't require any modification. We have, however, to change the parser entry point from <code>parse_integer</code> to <code>parse_expression</code>, so the new <code>cli.py</code> file will be</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_parser</span> <span class="k">as</span> <span class="n">cpar</span>
<span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_visitor</span> <span class="k">as</span> <span class="n">cvis</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">cvis</span><span class="o">.</span><span class="n">CalcVisitor</span><span class="p">()</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;smallcalc :&gt; &#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_expression</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">())</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bye!&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">continue</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>And a quick test of the CLI confirms that everything works fine</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>cli.py<span class="w"> </span>
smallcalc<span class="w"> </span>:&gt;<span class="w"> </span><span class="m">2</span>+4
<span class="o">(</span><span class="m">6</span>,<span class="w"> </span><span class="s1">&#39;integer&#39;</span><span class="o">)</span>
</code></pre></div>

<p>Everything? Well, not exactly. If I type just a single integer in the CLI the whole program crashes with an exception. If your solution doesn't blow up with a single integer, it means that you (probably) overengineered it a little. This is fine, but if you had implemented just what was needed to pass the tests the result would have been an error in that case.</p>
<p>Why do we have an error? Because we now parse the input with <code>parse_expression</code> and this method expects its input to be a full-formed expression, not a single integer. Generally speaking, our parser's entry point should be able to parse different syntax structures. We will improve this behaviour later, when we will address the problem of nested expressions.</p>
<hr>
<h3 id="solution_2">Solution<a class="headerlink" href="#solution_2" title="Permanent link">&para;</a></h3>
<p>The helper <code>_process_literal</code> does what <code>_process_integer</code> did before, which is to blindly return a token, this time with the <code>LITERAL</code> type.</p>
<div class="highlight"><pre><span></span><code><span class="n">LITERAL</span> <span class="o">=</span> <span class="s1">&#39;LITERAL&#39;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_process_literal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_current_token_and_skip</span><span class="p">(</span>
            <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">LITERAL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_char</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<p>The helper <code>_process_integer</code>, on the other hand, changes to return <code>None</code> when no integer can be parsed, which is easily checked with <code>isdigit</code>.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_process_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_current_token_and_skip</span><span class="p">(</span>
            <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_char</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<p>Last, the method <code>get_token</code> receives <code>_process_literal</code> as an additional case.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">eof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_eof</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">eof</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eof</span>

        <span class="n">eol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_eol</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">eol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eol</span>

        <span class="n">integer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_integer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">integer</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">integer</span>

        <span class="n">literal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_literal</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">literal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">literal</span>
</code></pre></div>

<p>The parser needs a node that represents the literal, namely <code>LiteralNode</code>, and a node to represent a binary operation, called <code>BinaryNode</code>. To avoid duplicating methods I created the <code>ValueNode</code> class and made both <code>IntegerNode</code> and <code>LiteralNode</code> inherit from that.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">smallcalc</span> <span class="kn">import</span> <span class="n">calc_lexer</span> <span class="k">as</span> <span class="n">clex</span>


<span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>  <span class="c1"># pragma: no cover</span>


<span class="k">class</span> <span class="nc">ValueNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>

    <span class="n">node_type</span> <span class="o">=</span> <span class="s1">&#39;value_node&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_type</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">IntegerNode</span><span class="p">(</span><span class="n">ValueNode</span><span class="p">):</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="s1">&#39;integer&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LiteralNode</span><span class="p">(</span><span class="n">ValueNode</span><span class="p">):</span>

    <span class="n">node_type</span> <span class="o">=</span> <span class="s1">&#39;literal&#39;</span>


<span class="k">class</span> <span class="nc">BinaryNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>

    <span class="n">node_type</span> <span class="o">=</span> <span class="s1">&#39;binary&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">right</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operator</span> <span class="o">=</span> <span class="n">operator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">right</span>

    <span class="k">def</span> <span class="nf">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_type</span><span class="p">,</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>

        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;operator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;operator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<p>The most important change, however, is in <code>CalcParser</code>, where I added the methods <code>parse_addsymbol</code> and <code>parse_expression</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CalcParser</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">parse_addsymbol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">LiteralNode</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">IntegerNode</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_integer</span><span class="p">()</span>
        <span class="n">operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_addsymbol</span><span class="p">()</span>
        <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_integer</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">BinaryNode</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
</code></pre></div>

<p>The visitor has to add the processing code for <code>binary</code> nodes, which assumes the operation is a sum, so it just needs to visit the left and right nodes.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CalcVisitor</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;integer&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="n">lvalue</span><span class="p">,</span> <span class="n">ltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span>
            <span class="n">rvalue</span><span class="p">,</span> <span class="n">rtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">lvalue</span> <span class="o">+</span> <span class="n">rvalue</span><span class="p">,</span> <span class="n">rtype</span>
</code></pre></div>

<hr>
<h2 id="level-4-multi-digit-integers">Level 4 - Multi-digit integers<a class="headerlink" href="#level-4-multi-digit-integers" title="Permanent link">&para;</a></h2>
<p><em>"So many."</em> - Braveheart (1995)</p>
<p>Let's move allowing integers to be made of multiple digits.</p>
<div class="highlight"><pre><span></span><code># An integer is a sequence of digits, + here means `one or more`
integer: [0-9]+
addsymbol: &#39;+&#39;
expression: integer addsymbol integer
</code></pre></div>

<p>Up to now our language can handle only single-digit integers, so this part shall be enhanced before moving to more complex syntax structures. The only component that requires a change is the lexer, as it should emit one single token containing all the digits. The test, consequently, goes in <code>tests/test_calc_lexer.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_tokens_understands_multidigit_integers</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;356&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;356&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOL</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p>There are many ways to solve this problem, one of the simplest (and a perfectly valid one) is using regular expressions (which are, if you think about it, another language).</p>
<p>If you do not know how to use regular expressions do yourself a favour and learn them! You can find a nice tutorial on them at <a href="https://regexone.com/">RegexOne</a>. If you already know the syntax but don't know how to use them in Python <a href="https://developers.google.com/edu/python/regular-expressions">this Google for Education page</a> and the <a href="https://docs.python.org/3/howto/regex.html">official documentation</a> are your friends.</p>
<p>After this test the CLI should be able to handle expressions like <code>123+456</code>. We don't need any change in the parser and in the visitor, can you tell why?</p>
<hr>
<h3 id="solution_3">Solution<a class="headerlink" href="#solution_3" title="Permanent link">&para;</a></h3>
<p>To provide support for multi-digit integers we just need to change the method <code>_process_integer</code> of the lexer. The new version makes use of a very simple regular expressions.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">re</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_process_integer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\d+&#39;</span><span class="p">)</span>

        <span class="n">match</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">tail</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">token_string</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_current_token_and_skip</span><span class="p">(</span>
            <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">token_string</span><span class="p">))</span>
        <span class="p">)</span>
</code></pre></div>

<p>The reason why we don't need to change the parser and the visitor is that nothing changed at that level. We altered the way the lexer identifies an integer token, but once that has been isolated the following steps are exactly the same as before.</p>
<hr>
<h2 id="level-5-whitespaces">Level 5 - Whitespaces<a class="headerlink" href="#level-5-whitespaces" title="Permanent link">&para;</a></h2>
<p><em>"Follow the white rabbit."</em> - The Matrix (1999)</p>
<p>The second limitation that our language has at the moment is that it cannot handle whitespaces. If you try to input an expression like <code>3 + 4</code> in the CLI the program will crash with an exception (why?). Traditionally, whitespaces are completely ignored by programming languages: in Python, as well as in C and many other languages, writing <code>3+4</code>, <code>3 + 4</code>, <code>3+ 4</code>, or <code>3   +   4</code> doesn't change the meaning at all. In Python, however, whitespaces matter at the beginning of the line, as indentation is used in lieu of parentheses.</p>
<p>How can we put such a behaviour in our language? Again, the lexer is the component in charge, as it should just skip whitespaces. So add this test to <code>tests/test_calc_lexer.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_tokens_ignores_spaces</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;3 + 5&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">LITERAL</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOL</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p>While you change the <code>CalcLexer</code> class to make it pass this test, ask yourself if the current structure of the class satisfies you or if it is the right time to refactor it, possibly even heavily rewriting some parts of it. You have a good test suite, now, so you can be sure that what you implemented is correct, at least according to the current requirements.</p>
<p>Note that we are hitting a limitation of unit testing here, which is that we should test that the language skips <em>any</em> amount of whitespaces, but it is impossible to write a test for this. We can test 1, 2, 100 whitespaces, but never <em>any</em> amount. The pragmatic solution, here is that of testing that the language skips one whitespace and leave further tests to be written only if specific errors arise in the future. The code should however try to provide a generic solution.</p>
<hr>
<h3 id="solution_4">Solution<a class="headerlink" href="#solution_4" title="Permanent link">&para;</a></h3>
<p>To process whitespaces I needed to add a helper called <code>_process_whitespace</code> with the same structure of the new <code>_process_integer</code>.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">_process_whitespace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\ +&#39;</span><span class="p">)</span>

        <span class="n">match</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">tail</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()))</span>
</code></pre></div>

<p>Note that the solution here is <code>'\ +'</code> which skips any amount of whitespaces, even though <code>'\ '</code> would have been enough to pass the test. As I said before, every time we have to test cases with "any" in them we have to be a bit less strict. TDD is not perfect, and remember that at the end of the day it's more important to have something that works and is not perfect than something that is perfect and doesn't work at all.</p>
<p>As this time I am not interested in returning whitespace tokens, I just want to skip them. The helper is therefore added to <code>get_token</code> without a <code>return</code> statement.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">get_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">eof</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_eof</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">eof</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eof</span>

        <span class="n">eol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_eol</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">eol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eol</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_process_whitespace</span><span class="p">()</span>

        <span class="n">integer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_integer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">integer</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">integer</span>

        <span class="n">literal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_literal</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">literal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">literal</span>
</code></pre></div>

<hr>
<h2 id="level-6-subtraction">Level 6 - Subtraction<a class="headerlink" href="#level-6-subtraction" title="Permanent link">&para;</a></h2>
<p><em>"I can add, subtract. I can make coffee. I can shuffle cards."</em> - The Bourne Identity (2002)</p>
<div class="highlight"><pre><span></span><code>integer: [0-9]+

# An addsymbol can be the symbol &#39;+&#39; or the symbol &#39;-&#39;
addsymbol: &#39;+&#39; | &#39;-&#39;

expression: integer addsymbol integer
</code></pre></div>

<p>Now that we addressed two basic issues of our language we can start enhancing the higher level syntactical structures. Since we implemented the addition operation, the most natural step forward is to implement subtraction. As for the addition, this change will involve all the three layers of the language, lexer, parser, and visitor.</p>
<p>Let us start teaching the lexer to understand the minus sign. The test that we need is the following (in <code>tests/test_calc_lexer.py</code>)</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_tokens_understands_subtraction</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;3 - 5&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">LITERAL</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOL</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p>Does the lexer require any change? Why?</p>
<p>As you can see the decision to handle operators and symbols as <code>LITERAL</code> tokens allows us to introduce new symbols without the need to change the lexer. This obviously means that we will need to tell the symbols apart in a later stage, as nothing happens automatically. We could have decided to represent each symbol with a specific token, like <code>PLUS</code> and <code>MINUS</code>, but if you think about it, this would not have really changed the code in later stages, as <code>PLUS</code> is just another symbol, exactly like <code>+</code> is.</p>
<p>Using specific tokens, however, can simplify things if we want to handle multi-character literals. If we have an operator like <code>-&gt;</code> (as in C) or <code>//</code> (like in Python), or something more complex, we could prefer to handle those in the lexer, emitting a single token with a specific name.</p>
<p>We could introduce in the lexer a table of accepted values for literals, which would lead to an earlier and better error reporting. At the moment our language accepts every literal between two integers (try with <code>$</code>, for example), but fails to process them in the parser, interpreting any literal as <code>+</code>. Feel free to expand the project in such a direction if you want.</p>
<p>The test for the parser is the following</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_parse_expression_understands_subtraction</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;2-3&quot;</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_expression</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">2</span>
        <span class="p">},</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">3</span>
        <span class="p">},</span>
        <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>which is a small variation of the previously implemented <code>test_parse_expression</code>.</p>
<p>The considerations made for the lexer are perfectly valid for the parser as well, so you should need no node change at this point. The last test we have to add is that of the visitor, which is again very similar to the previous one</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_visitor_expression_subtraction</span><span class="p">():</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">},</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">},</span>
        <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">cvis</span><span class="o">.</span><span class="n">CalcVisitor</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">)</span>
</code></pre></div>

<p>This time, however, we are at the end of the processing chain, and we have to deal with the difference symbol, namely to actually subtract numbers. To make this test pass, thus, you will need to change something in your <code>CalcVisitor</code> class.</p>
<p>Once your code passes this test, a quick test of the CLI shows that everything works as intended</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>cli.py<span class="w"> </span>
smallcalc<span class="w"> </span>:&gt;<span class="w"> </span><span class="m">4</span><span class="w"> </span>-<span class="w"> </span><span class="m">6</span>
<span class="o">(</span>-2,<span class="w"> </span><span class="s1">&#39;integer&#39;</span><span class="o">)</span>
</code></pre></div>

<p>and since we rely on Python to perform the actual subtraction we get negative numbers for free. Pay attention: we can have negative numbers in the results, but we cannot input negative numbers. This is something that we will have to add later.</p>
<hr>
<h3 id="solution_5">Solution<a class="headerlink" href="#solution_5" title="Permanent link">&para;</a></h3>
<p>Adding the addition binary operation changed code in the lexer, the parser, and in the visitor. That operation was however considered a generic binary operation, and only the visitor implements the actual <code>+</code> operation. So adding the subtraction works out of the box for the first two stages and requires me to change the visitor only, with a simple <code>if</code> condition on the value of the operator.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CalcVisitor</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;integer&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span><span class="p">:</span>
            <span class="n">lvalue</span><span class="p">,</span> <span class="n">ltype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span>
            <span class="n">rvalue</span><span class="p">,</span> <span class="n">rtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">])</span>

            <span class="n">operator</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;operator&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lvalue</span> <span class="o">+</span> <span class="n">rvalue</span><span class="p">,</span> <span class="n">rtype</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lvalue</span> <span class="o">-</span> <span class="n">rvalue</span><span class="p">,</span> <span class="n">rtype</span>
</code></pre></div>

<hr>
<h2 id="level-7-multiple-operations">Level 7 - Multiple operations<a class="headerlink" href="#level-7-multiple-operations" title="Permanent link">&para;</a></h2>
<p><em>"The machine simply does not operate as expected."</em> - The Prestige (2006)</p>
<div class="highlight"><pre><span></span><code>integer: [0-9]+
addsymbol: &#39;+&#39; | &#39;-&#39;

# A expression starts with a single integer and optionally
# contains an addsymbol and another expression
# (this is a recursive definition) 
expression: integer (addsymbol expression)
</code></pre></div>

<p>Before we dive into the fascinating but complex topic of nested operations, let us take a look and implement multiple operations, that is the application of a chain of "similar" operators with the same priority.</p>
<p>Since this tutorial is a practical approach to the construction of an interpreter, I will not go too deep into the subject matter. Feel free to check the references if you are interested in such topics. For the moment, it is sufficient to understand that addition and subtraction are two operations that have the same precedence, which means that their order can be changed without affecting the result.</p>
<p>For instance: the expression <code>3 + 4 - 5</code> gives <code>2</code> as a result. The result is the same if we perform <code>(3 + 4) - 5 = 7 - 5 = 2</code> or <code>3 + (4 - 5) = 3 - 1 = 2</code>, where the expressions between parentheses are executed first.</p>
<p>From the interpreter's point of view, then, we can process a chain of additions and subtractions without being concerned about precedence, which greatly simplifies our job. As the output of the parser is a tree, however, we need to find a way to represent such a chain of operations in that form. One way is to nest expressions, which means that each operation is a single <code>binary</code> node, with the left term containing an integer and the right one the rest of the expression. In the previous example <code>3 + 4 - 5</code> is represented by an addition between <code>3</code> and <code>4 - 5</code>. <code>4 - 5</code>, in turn, is another binary node, a subtraction between <code>4</code> and <code>5</code>.</p>
<p>Let us start checking if the lexer understand multiple operations</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_get_tokens_understands_multiple_operations</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>

    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;3 + 5 - 7&#39;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_tokens</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">LITERAL</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">LITERAL</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOL</span><span class="p">),</span>
        <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">EOF</span><span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p>If the current version of your lexer doesn't pass this test make the necessary changes to the code.</p>
<p>Now we should modify the parser. While expressing the test is very simple, actually creating the code that makes it pass is not that trivial. So, as an intermediate step, I will make you implement the code that allows the parser to check upcoming tokens.</p>
<p>One solution to this problem is to save the state of the parser, get as many tokens as we need, and then restore the status. Inspired by Git, I called those methods <code>stash</code> and <code>pop</code>. Put the following test in <code>tests/test_calc_lexer.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_lexer_can_stash_and_pop_status</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>
    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;3 5&#39;</span><span class="p">)</span>

    <span class="n">l</span><span class="o">.</span><span class="n">stash</span><span class="p">()</span>
    <span class="n">l</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">)</span>
</code></pre></div>

<p>As you can see the <code>get_token</code> call between <code>stash</code> and <code>pop</code> doesn't leave any trace.</p>
<p>Once your code is working implement the second test. Create a method <code>peek_token</code> that performs all the previous actions together</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_lexer_can_peek_token</span><span class="p">():</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">clex</span><span class="o">.</span><span class="n">CalcLexer</span><span class="p">()</span>
    <span class="n">l</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;3 + 5&#39;</span><span class="p">)</span>

    <span class="n">l</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">l</span><span class="o">.</span><span class="n">peek_token</span><span class="p">()</span> <span class="o">==</span> <span class="n">token</span><span class="o">.</span><span class="n">Token</span><span class="p">(</span><span class="n">clex</span><span class="o">.</span><span class="n">LITERAL</span><span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">)</span>
</code></pre></div>

<p>You can implement <code>peek_token</code> very easily leveraging <code>stash</code> and <code>pop</code>.</p>
<p>Now we are ready to face the test that covers nested operations, which goes in <code>tests/test_calc_parser.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_parse_expression_with_multiple_operations</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">cpar</span><span class="o">.</span><span class="n">CalcParser</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;2 + 3 - 4&quot;</span><span class="p">)</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parse_expression</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">asdict</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">2</span>
            <span class="p">},</span>
            <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">3</span>
            <span class="p">},</span>
            <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">},</span>
        <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>A note of warning: probably the first version of the code that makes this test pass will be horrible, as the logic involved is not trivial. Remember that your <strong>first goal is to make the test pass and then, with the battery of tests in your arsenal, to tidy up the code</strong>.</p>
<p>As usual, the last test involves the visitor</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">test_visitor_expression_with_multiple_operations</span><span class="p">():</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
        <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;binary&#39;</span><span class="p">,</span>
            <span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">3</span>
            <span class="p">},</span>
            <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">4</span>
            <span class="p">},</span>
            <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;-&#39;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">200</span>
        <span class="p">},</span>
        <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;literal&#39;</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;+&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">cvis</span><span class="o">.</span><span class="n">CalcVisitor</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">199</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">)</span>
</code></pre></div>

<p>What changes do you need to make to the <code>CalcVisitor</code> class? Why?</p>
<hr>
<h3 id="solution_6">Solution<a class="headerlink" href="#solution_6" title="Permanent link">&para;</a></h3>
<p>I made no assumptions on the length of the tokens stream in <code>get_tokens</code>, so processing multiple tokens comes out of the box in the lexer.</p>
<p>Adding <code>stash</code> and <code>pop</code> is not very complex, as the tests show exactly what we need to save and retrieve. Here I leverage the <code>position</code> attribute and the <code>goto</code> functions of the <code>TextBuffer</code> class.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">CalcLexer</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span> <span class="o">=</span> <span class="n">text_buffer</span><span class="o">.</span><span class="n">TextBuffer</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_token</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="p">[</span><span class="o">...</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_current_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">status</span><span class="p">[</span><span class="s1">&#39;text_storage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">position</span>
        <span class="n">status</span><span class="p">[</span><span class="s1">&#39;current_token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_token</span>
        <span class="k">return</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">stash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_current_status</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text_storage</span><span class="o">.</span><span class="n">goto</span><span class="p">(</span><span class="o">*</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;text_storage&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_token</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s1">&#39;current_token&#39;</span><span class="p">]</span>
</code></pre></div>

<p>Once <code>stash</code> and <code>pop</code> are in place implementing <code>peek_token</code> is trivial</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">peek_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stash</span><span class="p">()</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">token</span>
</code></pre></div>

<p>Finally, <code>peek_token</code> allows me to add support for multiple expressions in the parser.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">parse_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_integer</span><span class="p">()</span>

        <span class="n">next_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">peek_token</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">next_token</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">clex</span><span class="o">.</span><span class="n">LITERAL</span><span class="p">:</span>
            <span class="n">operator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_addsymbol</span><span class="p">()</span>
            <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_integer</span><span class="p">()</span>

            <span class="n">left</span> <span class="o">=</span> <span class="n">BinaryNode</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

            <span class="n">next_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">peek_token</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">left</span>
</code></pre></div>

<hr>
<h2 id="final-words">Final words<a class="headerlink" href="#final-words" title="Permanent link">&para;</a></h2>
<p>Phew! That was something, wasn't it? I think so, we went from nothing to a trivial calculator, but the engine we have under the bonnet is clearly powerful, so I'm already looking forward to implementing more complex syntax elements, like round brackets, multiplication, division, not to mention that sooner or later this should become a language, so we will need variables, functions, scopes, and so on.</p>
<p>The code I developed in this post is available on the GitHub repository tagged with <code>part1</code> (<a href="https://github.com/lgiordani/smallcalc/tree/part1">link</a>).</p>
<p>Well, See you in the next post of the series, then!</p>
<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">&para;</a></h2>
<p>Some links on compilers history</p>
<ul>
<li><a href="http://gcc.gnu.org/wiki/History">GCC history</a></li>
<li><a href="https://en.wikipedia.org/wiki/History_of_compiler_construction">History of compiler construction on Wikipedia</a></li>
</ul>
<p>Tutorials and analysis of compilers and parsers</p>
<ul>
<li>The beautiful <a href="https://ruslanspivak.com/lsbasi-part1/">"Let’s Build A Simple Interpreter"</a> series by Ruslan Spivak. Thanks Ruslan!</li>
<li>How to implement a programming language in JavaScript <a href="http://lisperator.net/pltut/">on Lisperator.net</a> by Mihai Bazon.</li>
<li><a href="http://www.buildyourownlisp.com/">Build Your Own Lisp</a></li>
<li><a href="http://blog.reverberate.org/2013/07/ll-and-lr-parsing-demystified.html">LL and LR Parsing Demystified</a> by Josh Haberman.</li>
</ul>
<p>Grammars</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form">Backus-Naur form on Wikipedia</a></li>
<li><a href="https://en.wikipedia.org/wiki/Extended_Backus%E2%80%93Naur_form">Extended Backus-Naur form on Wikipedia</a></li>
<li><a href="http://matt.might.net/articles/grammars-bnf-ebnf/">The language of languages</a></li>
</ul>
<h2 id="updates">Updates<a class="headerlink" href="#updates" title="Permanent link">&para;</a></h2>
<p>2017-12-24: Victor Uriarte (<a href="https://github.com/vmuriart">vmuriart</a>) spotted an important issue in a previous version of the post. The last two tests (<code>test_parse_expression_with_multiple_operations</code> and <code>test_visitor_expression_with_multiple_operations</code>) used a right-growing tree instead of a left-growing one. The problem with a right-growing tree is that an operator affects <em>everything</em> is on the right side, that is the whole rest of the operation. Thus, an operation like <code>10 - 1 + 1</code> would become <code>10 - (1 + 1)</code>, and the result is obviously different. I fixed the tests and the solution I give in the next posts. You can read Victor's issue <a href="https://github.com/lgiordani/smallcalc/issues/4">here</a>. Thanks Victor for spotting it!</p>
<h2 id="feedback">Feedback<a class="headerlink" href="#feedback" title="Permanent link">&para;</a></h2>
<p>Feel free to reach me on <a href="https://twitter.com/thedigicat">Twitter</a> if you have questions. The <a href="https://github.com/TheDigitalCatOnline/blog_source/issues">GitHub issues</a> page is the best place to submit corrections.</p>
  </div>

  <section class="links">
    <header>
      <h2>Part 1 of the A game of tokens series</h2>
    </header>
    <div>
      
      <h3>Next articles</h3>
      <ul>
        <li><a href="/blog/2017/10/01/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-2/">A game of tokens: write an interpreter in Python with TDD - Part 2</a></li>
        <li><a href="/blog/2017/10/31/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-3/">A game of tokens: write an interpreter in Python with TDD - Part 3</a></li>
        <li><a href="/blog/2018/06/02/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-4/">A game of tokens: write an interpreter in Python with TDD - Part 4</a></li>
        <li><a href="/blog/2020/08/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-5/">A game of tokens: write an interpreter in Python with TDD - Part 5</a></li>
      </ul>
    </div>
  </section>

  <section>
    <header>
      <h2>Related Posts</h2>
    </header>
    <div class="paginated-posts">
      <div class="posts">
	<article class="card">
          <a href="/blog/2020/08/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-5/">
            <img src="/images/a-game-of-tokens-5.jpg" alt="a-game-of-tokens-5" />
          </a>
          <div class="body">
            <a href="/blog/2020/08/09/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-5/"><h2>A game of tokens: write an interpreter in Python with TDD - Part 5</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
		<a href="/categories/compilers/" class="tag">compilers</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-08-09T18:00:00+01:00">Aug 9, 2020</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2017/10/31/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-3/">
            <img src="/images/a-game-of-tokens-3.jpg" alt="a-game-of-tokens-3" />
          </a>
          <div class="body">
            <a href="/blog/2017/10/31/a-game-of-tokens-write-an-interpreter-in-python-with-tdd-part-3/"><h2>A game of tokens: write an interpreter in Python with TDD - Part 3</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
		<a href="/categories/compilers/" class="tag">compilers</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2017-10-31T11:00:00+00:00">Oct 31, 2017</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2020-08-05T11:00:00+00:00">Aug 5, 2020</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/09/21/tdd-in-python-with-pytest-part-5/">
            <img src="/images/tdd-in-python-with-pytest-part-5.jpg" alt="tdd-in-python-with-pytest-part-5" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/21/tdd-in-python-with-pytest-part-5/"><h2>TDD in Python with pytest - Part 5</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-21T10:30:00+02:00">Sep 21, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2021-03-06T19:00:00+00:00">Mar 6, 2021</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/09/17/tdd-in-python-with-pytest-part-4/">
            <img src="/images/tdd-in-python-with-pytest-part-4.jpg" alt="tdd-in-python-with-pytest-part-4" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/17/tdd-in-python-with-pytest-part-4/"><h2>TDD in Python with pytest - Part 4</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-17T11:30:00+02:00">Sep 17, 2020</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/09/15/tdd-in-python-with-pytest-part-3/">
            <img src="/images/tdd-in-python-with-pytest-part-3.jpg" alt="tdd-in-python-with-pytest-part-3" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/15/tdd-in-python-with-pytest-part-3/"><h2>TDD in Python with pytest - Part 3</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-15T08:00:00+02:00">Sep 15, 2020</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/09/11/tdd-in-python-with-pytest-part-2/">
            <img src="/images/tdd-in-python-with-pytest-part-2.jpg" alt="tdd-in-python-with-pytest-part-2" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/11/tdd-in-python-with-pytest-part-2/"><h2>TDD in Python with pytest - Part 2</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-11T10:30:00+02:00">Sep 11, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2023-09-03T19:00:00+02:00">Sep 3, 2023</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/09/10/tdd-in-python-with-pytest-part-1/">
            <img src="/images/tdd-in-python-with-pytest-part-1.jpg" alt="tdd-in-python-with-pytest-part-1" />
          </a>
          <div class="body">
            <a href="/blog/2020/09/10/tdd-in-python-with-pytest-part-1/"><h2>TDD in Python with pytest - Part 1</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/oop/" class="tag">OOP</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/refactoring/" class="tag">refactoring</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-09-10T10:30:00+02:00">Sep 10, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2023-09-03T19:00:00+02:00">Sep 3, 2023</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/">
            <img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-3.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-3" />
          </a>
          <div class="body">
            <a href="/blog/2020/07/07/flask-project-setup-tdd-docker-postgres-and-more-part-3/"><h2>Flask project setup: TDD, Docker, Postgres and more - Part 3</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/aws/" class="tag">AWS</a>
		<a href="/categories/devops/" class="tag">devops</a>
		<a href="/categories/docker/" class="tag">Docker</a>
		<a href="/categories/flask/" class="tag">Flask</a>
		<a href="/categories/http/" class="tag">HTTP</a>
		<a href="/categories/postgres/" class="tag">Postgres</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
		<a href="/categories/www/" class="tag">WWW</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-07-07T13:00:00+01:00">Jul 7, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2021-02-23T20:00:00+00:00">Feb 23, 2021</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/">
            <img src="/images/flask-project-setup-tdd-docker-postgres-and-more-part-2.jpg" alt="flask-project-setup-tdd-docker-postgres-and-more-part-2" />
          </a>
          <div class="body">
            <a href="/blog/2020/07/06/flask-project-setup-tdd-docker-postgres-and-more-part-2/"><h2>Flask project setup: TDD, Docker, Postgres and more - Part 2</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/aws/" class="tag">AWS</a>
		<a href="/categories/devops/" class="tag">devops</a>
		<a href="/categories/docker/" class="tag">Docker</a>
		<a href="/categories/flask/" class="tag">Flask</a>
		<a href="/categories/http/" class="tag">HTTP</a>
		<a href="/categories/postgres/" class="tag">Postgres</a>
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
		<a href="/categories/www/" class="tag">WWW</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2020-07-06T13:00:00+01:00">Jul 6, 2020</time></p>
	      <p><i class="fas fa-edit"></i> Updated on <time datetime="2021-02-23T20:00:00+00:00">Feb 23, 2021</time></p>
	    </div>
          </div>
	</article>
	<article class="card">
          <a href="/blog/2019/05/27/youtube-channel/">
            <img src="/images/youtube-channel.jpg" alt="youtube-channel" />
          </a>
          <div class="body">
            <a href="/blog/2019/05/27/youtube-channel/"><h2>The Digital Cat Youtube Channel</h2></a>
	    <div class="info">
	      <p class="tags">
		<a href="/categories/pytest/" class="tag">pytest</a>
		<a href="/categories/python/" class="tag">Python</a>
		<a href="/categories/python2/" class="tag">Python2</a>
		<a href="/categories/python3/" class="tag">Python3</a>
		<a href="/categories/tdd/" class="tag">TDD</a>
		<a href="/categories/testing/" class="tag">testing</a>
		<a href="/categories/video/" class="tag">video</a>
              </p>
	      <p><i class="fas fa-calendar-alt"></i> <time datetime="2019-05-27T12:00:00+01:00">May 27, 2019</time></p>
	    </div>
          </div>
	</article>
      </div>
    </div>
  </section>
  
</div>

      </div>
    </div>
    <script src="/theme/js/packed.js?46a8f903"></script>

  </body>
</html>